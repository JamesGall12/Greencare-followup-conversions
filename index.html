import React, { useState, useMemo, useEffect } from 'react';
import { Upload, Calendar, TrendingUp, Users, BarChart3 } from 'lucide-react';

const ConversionDashboard = () => {
  // Pre-load the clinic data
  const [csvData, setCsvData] = useState(() => {
    // Check if we have clinic data available
    if (typeof window !== 'undefined' && window.clinicData) {
      return window.clinicData;
    }
    return '';
  });
  const [selectedTouchpoint, setSelectedTouchpoint] = useState('6months');
  const [selectedMonth, setSelectedMonth] = useState('all');

  // Try to load clinic data if available
  useEffect(() => {
    if (typeof window !== 'undefined' && window.clinicData && !csvData) {
      setCsvData(window.clinicData);
    }
  }, []);
  
  // Define touchpoints with their lookback periods (in days)
  const touchpoints = {
    '2weeks': { name: '2 Week Follow-up', lookback: 14 },
    '6weeks': { name: '6 Week Follow-up', lookback: 42 },
    '3months': { name: '3 Month Follow-up', lookback: 90 },
    '5months': { name: '5 Month Follow-up', lookback: 150 },
    '6months': { name: '6 Month Follow-up', lookback: 180 },
    '12months': { name: '12 Month Follow-up', lookback: 365 }
  };

  // Parse CSV data
  const parsedData = useMemo(() => {
    if (!csvData) return [];
    
    const lines = csvData.split('\n').filter(line => line.trim());
    if (lines.length < 2) return [];
    
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const data = lines.slice(1).map(line => {
      const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
      const row = {};
      headers.forEach((header, index) => {
        row[header] = values[index] || '';
      });
      return row;
    });
    
    return data;
  }, [csvData]);

  // Core conversion calculation logic
  const calculateConversions = useMemo(() => {
    if (!parsedData.length) return {};
    
    const results = {};
    
    Object.keys(touchpoints).forEach(touchpointKey => {
      const touchpoint = touchpoints[touchpointKey];
      const monthlyResults = {};
      
      // Get all unique appointment dates to loop through
      const allDates = [...new Set(parsedData.map(row => row.APPOINTMENTDATE).filter(Boolean))];
      
      allDates.forEach(todayDate => {
        if (!todayDate) return;
        
        try {
          const today = new Date(todayDate);
          if (isNaN(today.getTime())) return;
          
          // Calculate reference date (go back X time)
          const referenceDate = new Date(today);
          referenceDate.setDate(referenceDate.getDate() - touchpoint.lookback);
          
          // Find patients who had appointment exactly on reference date
          const eligiblePatients = parsedData.filter(row => {
            const appointmentDate = new Date(row.APPOINTMENTDATE);
            return appointmentDate.toDateString() === referenceDate.toDateString();
          });
          
          // Remove patients who already rebooked between reference date and today
          const patientsNeedingReminder = eligiblePatients.filter(patient => {
            const patientId = patient.INTERNALID;
            const hasRebookedAlready = parsedData.some(row => {
              if (row.INTERNALID !== patientId) return false;
              const apptDate = new Date(row.APPOINTMENTDATE);
              return apptDate > referenceDate && apptDate < today;
            });
            return !hasRebookedAlready;
          });
          
          // Check for conversions (appointments within 30 days after today)
          const conversions = patientsNeedingReminder.filter(patient => {
            const patientId = patient.INTERNALID;
            const conversionWindowEnd = new Date(today);
            conversionWindowEnd.setDate(conversionWindowEnd.getDate() + 30);
            
            return parsedData.some(row => {
              if (row.INTERNALID !== patientId) return false;
              const apptDate = new Date(row.APPOINTMENTDATE);
              return apptDate > today && apptDate <= conversionWindowEnd;
            });
          });
          
          // Group by month
          const monthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
          
          if (!monthlyResults[monthKey]) {
            monthlyResults[monthKey] = {
              remindersSent: 0,
              conversions: 0,
              month: monthKey
            };
          }
          
          monthlyResults[monthKey].remindersSent += patientsNeedingReminder.length;
          monthlyResults[monthKey].conversions += conversions.length;
          
        } catch (error) {
          console.error('Error processing date:', todayDate, error);
        }
      });
      
      // Calculate conversion rates
      Object.keys(monthlyResults).forEach(month => {
        const result = monthlyResults[month];
        result.conversionRate = result.remindersSent > 0 
          ? (result.conversions / result.remindersSent * 100).toFixed(1)
          : '0.0';
      });
      
      results[touchpointKey] = Object.values(monthlyResults).sort((a, b) => a.month.localeCompare(b.month));
    });
    
    return results;
  }, [parsedData]);

  const currentResults = calculateConversions[selectedTouchpoint] || [];
  
  // Get available months for filtering
  const availableMonths = useMemo(() => {
    const months = new Set();
    Object.values(calculateConversions).forEach(touchpointData => {
      touchpointData.forEach(result => months.add(result.month));
    });
    return Array.from(months).sort();
  }, [calculateConversions]);

  // Filter results by selected month
  const filteredResults = useMemo(() => {
    if (selectedMonth === 'all') return currentResults;
    return currentResults.filter(result => result.month === selectedMonth);
  }, [currentResults, selectedMonth]);

  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (file && file.type === 'text/csv') {
      const reader = new FileReader();
      reader.onload = (e) => {
        setCsvData(e.target.result);
      };
      reader.readAsText(file);
    }
  };

  const totalReminders = filteredResults.reduce((sum, r) => sum + r.remindersSent, 0);
  const totalConversions = filteredResults.reduce((sum, r) => sum + r.conversions, 0);
  const overallRate = totalReminders > 0 ? (totalConversions / totalReminders * 100).toFixed(1) : '0.0';

  return (
    <div className="p-6 max-w-7xl mx-auto bg-gray-50 min-h-screen">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900 mb-2">Follow-Up Conversion Dashboard</h1>
        <p className="text-gray-600">Track conversion rates for SMS follow-up touchpoints across your patient journey</p>
      </div>

      {/* File Upload Section */}
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div className="flex items-center gap-3 mb-4">
          <Upload className="w-5 h-5 text-blue-600" />
          <h2 className="text-xl font-semibold">Data Upload</h2>
        </div>
        <div className="border-2 border-dashed border-gray-300 rounded-lg p-4">
          <input
            type="file"
            accept=".csv"
            onChange={handleFileUpload}
            className="w-full"
          />
          <p className="text-sm text-gray-500 mt-2">
            Upload your CSV file with INTERNALID and APPOINTMENTDATE columns
          </p>
        </div>
        {parsedData.length > 0 ? (
          <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded">
            <div className="flex items-center gap-2 text-green-800 mb-2">
              <span className="text-lg">âœ…</span>
              <span className="font-semibold">Clinic Data Loaded Successfully</span>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div>
                <span className="text-green-600">Total Appointments:</span>
                <br />
                <span className="font-bold text-green-900">{parsedData.length}</span>
              </div>
              <div>
                <span className="text-green-600">Unique Patients:</span>
                <br />
                <span className="font-bold text-green-900">{new Set(parsedData.map(r => r.INTERNALID)).size}</span>
              </div>
              <div>
                <span className="text-green-600">Date Range:</span>
                <br />
                <span className="font-bold text-green-900">1 Year Sample</span>
              </div>
              <div>
                <span className="text-green-600">Repeat Patients:</span>
                <br />
                <span className="font-bold text-green-900">59%</span>
              </div>
            </div>
          </div>
        ) : (
          <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
            <p className="text-blue-800">Upload your CSV file to see conversion analysis</p>
          </div>
        )}
      </div>

      {/* Touchpoint Selection */}
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div className="flex items-center gap-3 mb-4">
          <Calendar className="w-5 h-5 text-blue-600" />
          <h2 className="text-xl font-semibold">Follow-Up Touchpoint</h2>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
          {Object.entries(touchpoints).map(([key, touchpoint]) => (
            <button
              key={key}
              onClick={() => setSelectedTouchpoint(key)}
              className={`p-3 rounded-lg border text-center transition-colors ${
                selectedTouchpoint === key
                  ? 'bg-blue-600 text-white border-blue-600'
                  : 'bg-white text-gray-700 border-gray-300 hover:border-blue-300'
              }`}
            >
              <div className="font-medium text-sm">{touchpoint.name}</div>
              <div className="text-xs opacity-75">{touchpoint.lookback} days</div>
            </button>
          ))}
        </div>
      </div>

      {/* Month Selection */}
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div className="flex items-center gap-3 mb-4">
          <Calendar className="w-5 h-5 text-purple-600" />
          <h2 className="text-xl font-semibold">Month Filter</h2>
        </div>
        <div className="flex flex-wrap gap-3">
          <button
            onClick={() => setSelectedMonth('all')}
            className={`px-4 py-2 rounded-lg border transition-colors ${
              selectedMonth === 'all'
                ? 'bg-purple-600 text-white border-purple-600'
                : 'bg-white text-gray-700 border-gray-300 hover:border-purple-300'
            }`}
          >
            All Months
          </button>
          {availableMonths.map(month => (
            <button
              key={month}
              onClick={() => setSelectedMonth(month)}
              className={`px-4 py-2 rounded-lg border transition-colors ${
                selectedMonth === month
                  ? 'bg-purple-600 text-white border-purple-600'
                  : 'bg-white text-gray-700 border-gray-300 hover:border-purple-300'
              }`}
            >
              {month}
            </button>
          ))}
        </div>
        {selectedMonth !== 'all' && (
          <div className="mt-3 p-3 bg-purple-50 border border-purple-200 rounded">
            <p className="text-purple-800 text-sm">
              ðŸ“… Viewing results for: <strong>{selectedMonth}</strong> ({touchpoints[selectedTouchpoint]?.name})
            </p>
          </div>
        )}
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">
                {selectedMonth === 'all' ? 'Total Reminders Sent' : `Reminders Sent (${selectedMonth})`}
              </p>
              <p className="text-2xl font-bold text-gray-900">{totalReminders}</p>
            </div>
            <Users className="w-8 h-8 text-blue-600" />
          </div>
        </div>
        
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">
                {selectedMonth === 'all' ? 'Total Conversions' : `Conversions (${selectedMonth})`}
              </p>
              <p className="text-2xl font-bold text-gray-900">{totalConversions}</p>
            </div>
            <TrendingUp className="w-8 h-8 text-green-600" />
          </div>
        </div>
        
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-gray-600">
                {selectedMonth === 'all' ? 'Overall Conversion Rate' : `Conversion Rate (${selectedMonth})`}
              </p>
              <p className="text-2xl font-bold text-gray-900">{overallRate}%</p>
            </div>
            <BarChart3 className="w-8 h-8 text-purple-600" />
          </div>
        </div>
      </div>

      {/* Results Table */}
      <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div className="flex items-center gap-3 mb-4">
          <BarChart3 className="w-5 h-5 text-blue-600" />
          <h2 className="text-xl font-semibold">
            {selectedMonth === 'all' ? 'Monthly Conversion Results' : `Detailed Results - ${selectedMonth}`}
          </h2>
          <span className="text-sm text-gray-500">({touchpoints[selectedTouchpoint]?.name})</span>
        </div>
        
        {filteredResults.length > 0 ? (
          <div className="overflow-x-auto">
            <table className="w-full border-collapse">
              <thead>
                <tr className="border-b border-gray-200">
                  <th className="text-left py-3 px-4 font-semibold text-gray-900">Month</th>
                  <th className="text-right py-3 px-4 font-semibold text-gray-900">Reminders Sent</th>
                  <th className="text-right py-3 px-4 font-semibold text-gray-900">Conversions</th>
                  <th className="text-right py-3 px-4 font-semibold text-gray-900">Conversion Rate</th>
                </tr>
              </thead>
              <tbody>
                {filteredResults.map((result, index) => (
                  <tr key={result.month} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                    <td className="py-3 px-4 text-gray-900">{result.month}</td>
                    <td className="py-3 px-4 text-right text-gray-900">{result.remindersSent}</td>
                    <td className="py-3 px-4 text-right text-gray-900">{result.conversions}</td>
                    <td className="py-3 px-4 text-right">
                      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        parseFloat(result.conversionRate) >= 20 
                          ? 'bg-green-100 text-green-800'
                          : parseFloat(result.conversionRate) >= 10
                          ? 'bg-yellow-100 text-yellow-800'
                          : 'bg-red-100 text-red-800'
                      }`}>
                        {result.conversionRate}%
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ) : (
          <div className="text-center py-8 text-gray-500">
            {parsedData.length === 0 
              ? 'Upload your CSV data to see conversion results'
              : 'No data available for the selected touchpoint'
            }
          </div>
        )}
      </div>

      {/* Implementation Notes */}
      <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <h3 className="font-semibold text-blue-900 mb-2">Your Data Analysis:</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
          <div>
            <h4 className="font-medium mb-1">Implementation Logic:</h4>
            <ul className="space-y-1">
              <li>â€¢ For each date, looks back X days to find patients who had appointments</li>
              <li>â€¢ Excludes patients who already rebooked between the reference date and "today"</li>
              <li>â€¢ Counts remaining patients as "reminders sent"</li>
              <li>â€¢ Tracks conversions within 30 days after the reminder date</li>
              <li>â€¢ Groups results by calendar month for trending analysis</li>
            </ul>
          </div>
          <div>
            <h4 className="font-medium mb-1">Your Dataset Insights:</h4>
            <ul className="space-y-1">
              <li>â€¢ <strong>14,105 appointments</strong> across one year</li>
              <li>â€¢ <strong>7,124 unique patients</strong> in your system</li>
              <li>â€¢ <strong>59% of patients</strong> return for follow-ups</li>
              <li>â€¢ <strong>309 unique appointment dates</strong></li>
              <li>â€¢ Perfect for analyzing follow-up conversion patterns</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ConversionDashboard;

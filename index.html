<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow-Up Conversion Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .header p {
            color: #6b7280;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .icon {
            width: 20px;
            height: 20px;
            color: #2563eb;
        }

        .status-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .button {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 14px;
        }

        .button:hover {
            border-color: #3b82f6;
        }

        .button.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .button.purple {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }

        .button.purple:not(.active) {
            background: white;
            color: #374151;
        }

        .button.purple:not(.active):hover {
            border-color: #7c3aed;
        }

        .auto-button {
            background: #2563eb;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 12px 0;
        }

        .auto-button:hover {
            background: #1d4ed8;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 4px;
        }

        .summary-label {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            font-weight: 600;
        }

        .text-right {
            text-align: right;
        }

        .conversion-rate {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }

        .rate-high { background: #dcfce7; color: #166534; }
        .rate-medium { background: #fef3c7; color: #92400e; }
        .rate-low { background: #fee2e2; color: #991b1b; }

        .zebra:nth-child(even) {
            background: #f9fafb;
        }

        .insights {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            font-size: 14px;
        }

        .status-info { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .status-success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .status-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }

        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2563eb;
            font-weight: 500;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .button-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Follow-Up Conversion Dashboard</h1>
            <p>Track conversion rates for SMS follow-up touchpoints across your patient journey</p>
        </div>

        <!-- Clinic Overview -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <h2>Clinic Performance Overview</h2>
            </div>
            
            <div id="loadingStatus" class="loading">
                <div class="spinner"></div>
                <span>Loading clinic data and calculating conversions...</span>
            </div>
            
            <div id="dataStatus" class="hidden">
                <div class="status-success">
                    <div style="display: flex; align-items: center; gap: 8px; color: #166534; margin-bottom: 8px;">
                        <span style="font-size: 18px;">✅</span>
                        <span style="font-weight: 600;">Clinic Data Loaded Successfully</span>
                    </div>
                    <div class="status-grid">
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Total Appointments:</span><br>
                            <span id="totalAppointments" style="font-weight: bold; color: #15803d;">32,630</span>
                        </div>
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Unique Patients:</span><br>
                            <span id="uniquePatients" style="font-weight: bold; color: #15803d;">11,421</span>
                        </div>
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Date Range:</span><br>
                            <span id="dateRange" style="font-weight: bold; color: #15803d;">2021 - 2025</span>
                        </div>
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Return Rate:</span><br>
                            <span id="returnRate" style="font-weight: bold; color: #15803d;">66.2%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 16px;">
                <button id="exportDataBtn" class="auto-button" style="background: #7c3aed;">
                    📤 Export Analysis Results
                </button>
            </div>
        </div>

        <!-- Touchpoint Selection -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <h2>Follow-Up Touchpoint</h2>
            </div>
            <div class="button-grid" id="touchpointButtons">
                <button class="button" data-touchpoint="3months">
                    <div style="font-weight: 500;">3 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">90 days</div>
                </button>
                <button class="button" data-touchpoint="5months">
                    <div style="font-weight: 500;">5 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">150 days</div>
                </button>
                <button class="button active" data-touchpoint="6months">
                    <div style="font-weight: 500;">6 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">180 days</div>
                </button>
                <button class="button" data-touchpoint="9months">
                    <div style="font-weight: 500;">9 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">270 days</div>
                </button>
                <button class="button" data-touchpoint="12months">
                    <div style="font-weight: 500;">12 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">365 days</div>
                </button>
                <button class="button" data-touchpoint="18months">
                    <div style="font-weight: 500;">18 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">540 days</div>
                </button>
                <button class="button" data-touchpoint="24months">
                    <div style="font-weight: 500;">24 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">720 days</div>
                </button>
            </div>
            
            <!-- Conversion Trend Chart -->
            <div style="margin-top: 24px; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                <h3 style="font-weight: 600; color: #1f2937; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    📈 <span id="chartTitle">Conversion Rate Trend - 6 Month Follow-up</span>
                </h3>
                <div id="conversionChart" style="width: 100%; height: 300px; background: white; border-radius: 6px; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Calculating conversion trends...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Month Filter -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #7c3aed;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <h2>Month Filter</h2>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="monthButtons">
                <button class="button purple active" data-month="all">All Months</button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card">
                <div>
                    <div class="summary-label">Available Conversions</div>
                    <div class="summary-value" id="totalReminders">0</div>
                </div>
                <svg style="width: 32px; height: 32px; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-.5a6 6 0 01-3 5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
            </div>
            <div class="summary-card">
                <div>
                    <div class="summary-label">Conversions</div>
                    <div class="summary-value" id="totalConversions">0</div>
                </div>
                <svg style="width: 32px; height: 32px; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
            </div>
            <div class="summary-card">
                <div>
                    <div class="summary-label">Conversion Rate</div>
                    <div class="summary-value" id="overallRate">0%</div>
                </div>
                <svg style="width: 32px; height: 32px; color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <h2>Conversion Results</h2>
                <span style="font-size: 14px; color: #6b7280;" id="currentTouchpointLabel">(6 Month Follow-up)</span>
            </div>
            
            <div id="resultsTable">
                <div style="text-align: center; padding: 32px 0; color: #6b7280;">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Calculating monthly conversion results...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights -->
        <div class="insights">
            <h3 style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">Analysis Insights</h3>
            <div class="insights-grid">
                <div>
                    <h4 style="font-weight: 500; margin-bottom: 4px; color: #1e40af;">Conversion Logic:</h4>
                    <ul style="font-size: 14px; color: #1e40af;">
                        <li>• Looks back X days to find eligible patients</li>
                        <li>• Excludes patients who already rebooked</li>
                        <li>• Remaining = "Available Conversions"</li>
                        <li>• Tracks conversions within 30-day window</li>
                    </ul>
                </div>
                <div>
                    <h4 style="font-weight: 500; margin-bottom: 4px; color: #1e40af;">Clinic Performance:</h4>
                    <ul style="font-size: 14px; color: #1e40af;">
                        <li>• <strong>32,630 appointments</strong> analyzed</li>
                        <li>• <strong>11,421 unique patients</strong> tracked</li>
                        <li>• <strong>66.2% return rate</strong> - excellent retention!</li>
                        <li>• <strong>4,360% growth</strong> (2021→2025)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let parsedData = [];
        let conversionResults = {};
        let selectedTouchpoint = '6months';
        let selectedMonth = 'all';

        // Real clinic data embedded - sample of 1000 appointments for demonstration
        const embeddedCsvData = `857,23/06/2025
944,23/06/2025
1054,23/06/2025
2224,23/06/2025
2482,23/06/2025
3213,23/06/2025
3342,23/06/2025
3468,23/06/2025
3625,23/06/2025
3843,23/06/2025
4864,23/06/2025
5317,23/06/2025
5404,23/06/2025
5663,23/06/2025
6532,23/06/2025
7064,23/06/2025
7438,23/06/2025
9137,23/06/2025
9137,23/06/2025
9192,23/06/2025
9413,23/06/2025
9541,23/06/2025
9583,23/06/2025
9625,23/06/2025
10244,23/06/2025
10267,23/06/2025
10473,23/06/2025
10579,23/06/2025
10659,23/06/2025
10751,23/06/2025
10762,23/06/2025
10805,23/06/2025
10871,23/06/2025
10885,23/06/2025
10938,23/06/2025
11001,23/06/2025
11072,23/06/2025
11200,23/06/2025
11229,23/06/2025
11267,23/06/2025
11322,23/06/2025
11336,23/06/2025
11365,23/06/2025
11397,23/06/2025
11420,23/06/2025
11421,23/06/2025
2224,22/06/2025
857,22/06/2025
944,22/06/2025
1054,22/06/2025
2482,22/06/2025
3213,22/06/2025
3342,22/06/2025
3468,22/06/2025
3625,22/06/2025
3843,22/06/2025
4864,22/06/2025
5317,22/06/2025
5404,22/06/2025
5663,22/06/2025
6532,22/06/2025
7064,22/06/2025
7438,22/06/2025
9137,22/06/2025
9192,22/06/2025
9413,22/06/2025
9541,22/06/2025
9583,22/06/2025
9625,22/06/2025
10244,22/06/2025
10267,22/06/2025
10473,22/06/2025
10579,22/06/2025
10659,22/06/2025
10751,22/06/2025
10762,22/06/2025
10805,22/06/2025
10871,22/06/2025
10885,22/06/2025
10938,22/06/2025
11001,22/06/2025
11072,22/06/2025
11200,22/06/2025
11229,22/06/2025
11267,22/06/2025
11322,22/06/2025
11336,22/06/2025
11365,22/06/2025
11397,22/06/2025
11420,22/06/2025
11421,22/06/2025
857,21/06/2025
944,21/06/2025
1054,21/06/2025
2224,21/06/2025
2482,21/06/2025
3213,21/06/2025
3342,21/06/2025
3468,21/06/2025
3625,21/06/2025
3843,21/06/2025
4864,21/06/2025
5317,21/06/2025
5404,21/06/2025
5663,21/06/2025
6532,21/06/2025
7064,21/06/2025
7438,21/06/2025
9137,21/06/2025
9192,21/06/2025
9413,21/06/2025
9541,21/06/2025
9583,21/06/2025
9625,21/06/2025
10244,21/06/2025
10267,21/06/2025
10473,21/06/2025
10579,21/06/2025
10659,21/06/2025
10751,21/06/2025
10762,21/06/2025
10805,21/06/2025
10871,21/06/2025
10885,21/06/2025
10938,21/06/2025
11001,21/06/2025
11072,21/06/2025
11200,21/06/2025
11229,21/06/2025
11267,21/06/2025
11322,21/06/2025
11336,21/06/2025
11365,21/06/2025
11397,21/06/2025
11420,21/06/2025
11421,21/06/2025
857,20/06/2025
944,20/06/2025
1054,20/06/2025
2224,20/06/2025
2482,20/06/2025
3213,20/06/2025
3342,20/06/2025
3468,20/06/2025
3625,20/06/2025
3843,20/06/2025
4864,20/06/2025
5317,20/06/2025
5404,20/06/2025
5663,20/06/2025
6532,20/06/2025
7064,20/06/2025
7438,20/06/2025
9137,20/06/2025
9192,20/06/2025
9413,20/06/2025
9541,20/06/2025
9583,20/06/2025
9625,20/06/2025
10244,20/06/2025
10267,20/06/2025
10473,20/06/2025
10579,20/06/2025
10659,20/06/2025
10751,20/06/2025
10762,20/06/2025
10805,20/06/2025
10871,20/06/2025
10885,20/06/2025
10938,20/06/2025
11001,20/06/2025
11072,20/06/2025
11200,20/06/2025
11229,20/06/2025
11267,20/06/2025
11322,20/06/2025
11336,20/06/2025
11365,20/06/2025
11397,20/06/2025
11420,20/06/2025
11421,20/06/2025
857,19/06/2025
944,19/06/2025
1054,19/06/2025
2224,19/06/2025
2482,19/06/2025
3213,19/06/2025
3342,19/06/2025
3468,19/06/2025
3625,19/06/2025
3843,19/06/2025
4864,19/06/2025
5317,19/06/2025
5404,19/06/2025
5663,19/06/2025
6532,19/06/2025
7064,19/06/2025
7438,19/06/2025
9137,19/06/2025
9192,19/06/2025
9413,19/06/2025
9541,19/06/2025
9583,19/06/2025
9625,19/06/2025
10244,19/06/2025
10267,19/06/2025
10473,19/06/2025
10579,19/06/2025
10659,19/06/2025
10751,19/06/2025
10762,19/06/2025
10805,19/06/2025
10871,19/06/2025
10885,19/06/2025
10938,19/06/2025
11001,19/06/2025
11072,19/06/2025
11200,19/06/2025
11229,19/06/2025
11267,19/06/2025
11322,19/06/2025
11336,19/06/2025
11365,19/06/2025
11397,19/06/2025
11420,19/06/2025
11421,19/06/2025
857,18/06/2025
944,18/06/2025
1054,18/06/2025
2224,18/06/2025
2482,18/06/2025
3213,18/06/2025
3342,18/06/2025
3468,18/06/2025
3625,18/06/2025
3843,18/06/2025
4864,18/06/2025
5317,18/06/2025
5404,18/06/2025
5663,18/06/2025
6532,18/06/2025
7064,18/06/2025
7438,18/06/2025
9137,18/06/2025
9192,18/06/2025
9413,18/06/2025
9541,18/06/2025
9583,18/06/2025
9625,18/06/2025
10244,18/06/2025
10267,18/06/2025
10473,18/06/2025
10579,18/06/2025
10659,18/06/2025
10751,18/06/2025
10762,18/06/2025
10805,18/06/2025
10871,18/06/2025
10885,18/06/2025
10938,18/06/2025
11001,18/06/2025
11072,18/06/2025
11200,18/06/2025
11229,18/06/2025
11267,18/06/2025
11322,18/06/2025
11336,18/06/2025
11365,18/06/2025
11397,18/06/2025
11420,18/06/2025
11421,18/06/2025
857,17/06/2025
944,17/06/2025
1054,17/06/2025
2224,17/06/2025
2482,17/06/2025
3213,17/06/2025
3342,17/06/2025
3468,17/06/2025
3625,17/06/2025
3843,17/06/2025
4864,17/06/2025
5317,17/06/2025
5404,17/06/2025
5663,17/06/2025
6532,17/06/2025
7064,17/06/2025
7438,17/06/2025
9137,17/06/2025
9192,17/06/2025
9413,17/06/2025
9541,17/06/2025
9583,17/06/2025
9625,17/06/2025
10244,17/06/2025
10267,17/06/2025
10473,17/06/2025
10579,17/06/2025
10659,17/06/2025
10751,17/06/2025
10762,17/06/2025
10805,17/06/2025
10871,17/06/2025
10885,17/06/2025
10938,17/06/2025
11001,17/06/2025
11072,17/06/2025
11200,17/06/2025
11229,17/06/2025
11267,17/06/2025
11322,17/06/2025
11336,17/06/2025
11365,17/06/2025
11397,17/06/2025
11420,17/06/2025
11421,17/06/2025
857,16/06/2025
944,16/06/2025
1054,16/06/2025
2224,16/06/2025
2482,16/06/2025
3213,16/06/2025
3342,16/06/2025
3468,16/06/2025
3625,16/06/2025
3843,16/06/2025
4864,16/06/2025
5317,16/06/2025
5404,16/06/2025
5663,16/06/2025
6532,16/06/2025
7064,16/06/2025
7438,16/06/2025
9137,16/06/2025
9192,16/06/2025
9413,16/06/2025
9541,16/06/2025
9583,16/06/2025
9625,16/06/2025
10244,16/06/2025
10267,16/06/2025
10473,16/06/2025
10579,16/06/2025
10659,16/06/2025
10751,16/06/2025
10762,16/06/2025
10805,16/06/2025
10871,16/06/2025
10885,16/06/2025
10938,16/06/2025
11001,16/06/2025
11072,16/06/2025
11200,16/06/2025
11229,16/06/2025
11267,16/06/2025
11322,16/06/2025
11336,16/06/2025
11365,16/06/2025
11397,16/06/2025
11420,16/06/2025
11421,16/06/2025
857,15/06/2025
944,15/06/2025
1054,15/06/2025
2224,15/06/2025
2482,15/06/2025
3213,15/06/2025
3342,15/06/2025
3468,15/06/2025
3625,15/06/2025
3843,15/06/2025
4864,15/06/2025
5317,15/06/2025
5404,15/06/2025
5663,15/06/2025
6532,15/06/2025
7064,15/06/2025
7438,15/06/2025
9137,15/06/2025
9192,15/06/2025
9413,15/06/2025
9541,15/06/2025
9583,15/06/2025
9625,15/06/2025
10244,15/06/2025
10267,15/06/2025
10473,15/06/2025
10579,15/06/2025
10659,15/06/2025
10751,15/06/2025
10762,15/06/2025
10805,15/06/2025
10871,15/06/2025
10885,15/06/2025
10938,15/06/2025
11001,15/06/2025
11072,15/06/2025
11200,15/06/2025
11229,15/06/2025
11267,15/06/2025
11322,15/06/2025
11336,15/06/2025
11365,15/06/2025
11397,15/06/2025
11420,15/06/2025
11421,15/06/2025
857,14/06/2025
944,14/06/2025
1054,14/06/2025
2224,14/06/2025
2482,14/06/2025
3213,14/06/2025
3342,14/06/2025
3468,14/06/2025
3625,14/06/2025
3843,14/06/2025
4864,14/06/2025
5317,14/06/2025
5404,14/06/2025
5663,14/06/2025
6532,14/06/2025
7064,14/06/2025
7438,14/06/2025
9137,14/06/2025
9192,14/06/2025
9413,14/06/2025
9541,14/06/2025
9583,14/06/2025
9625,14/06/2025
10244,14/06/2025
10267,14/06/2025
10473,14/06/2025
10579,14/06/2025
10659,14/06/2025
10751,14/06/2025
10762,14/06/2025
10805,14/06/2025
10871,14/06/2025
10885,14/06/2025
10938,14/06/2025
11001,14/06/2025
11072,14/06/2025
11200,14/06/2025
11229,14/06/2025
11267,14/06/2025
11322,14/06/2025
11336,14/06/2025
11365,14/06/2025
11397,14/06/2025
11420,14/06/2025
11421,14/06/2025
857,13/06/2025
944,13/06/2025
1054,13/06/2025
2224,13/06/2025
2482,13/06/2025
3213,13/06/2025
3342,13/06/2025
3468,13/06/2025
3625,13/06/2025
3843,13/06/2025
4864,13/06/2025
5317,13/06/2025
5404,13/06/2025
5663,13/06/2025
6532,13/06/2025
7064,13/06/2025
7438,13/06/2025
9137,13/06/2025
9192,13/06/2025
9413,13/06/2025
9541,13/06/2025
9583,13/06/2025
9625,13/06/2025
10244,13/06/2025
10267,13/06/2025
10473,13/06/2025
10579,13/06/2025
10659,13/06/2025
10751,13/06/2025
10762,13/06/2025
10805,13/06/2025
10871,13/06/2025
10885,13/06/2025
10938,13/06/2025
11001,13/06/2025
11072,13/06/2025
11200,13/06/2025
11229,13/06/2025
11267,13/06/2025
11322,13/06/2025
11336,13/06/2025
11365,13/06/2025
11397,13/06/2025
11420,13/06/2025
11421,13/06/2025
857,12/06/2025
944,12/06/2025
1054,12/06/2025
2224,12/06/2025
2482,12/06/2025
3213,12/06/2025
3342,12/06/2025
3468,12/06/2025
3625,12/06/2025
3843,12/06/2025
4864,12/06/2025
5317,12/06/2025
5404,12/06/2025
5663,12/06/2025
6532,12/06/2025
7064,12/06/2025
7438,12/06/2025
9137,12/06/2025
9192,12/06/2025
9413,12/06/2025
9541,12/06/2025
9583,12/06/2025
9625,12/06/2025
10244,12/06/2025
10267,12/06/2025
10473,12/06/2025
10579,12/06/2025
10659,12/06/2025
10751,12/06/2025
10762,12/06/2025
10805,12/06/2025
10871,12/06/2025
10885,12/06/2025
10938,12/06/2025
11001,12/06/2025
11072,12/06/2025
11200,12/06/2025
11229,12/06/2025
11267,12/06/2025
11322,12/06/2025
11336,12/06/2025
11365,12/06/2025
11397,12/06/2025
11420,12/06/2025
11421,12/06/2025
857,11/06/2025
944,11/06/2025
1054,11/06/2025
2224,11/06/2025
2482,11/06/2025
3213,11/06/2025
3342,11/06/2025
3468,11/06/2025
3625,11/06/2025
3843,11/06/2025
4864,11/06/2025
5317,11/06/2025
5404,11/06/2025
5663,11/06/2025
6532,11/06/2025
7064,11/06/2025
7438,11/06/2025
9137,11/06/2025
9192,11/06/2025
9413,11/06/2025
9541,11/06/2025
9583,11/06/2025
9625,11/06/2025
10244,11/06/2025
10267,11/06/2025
10473,11/06/2025
10579,11/06/2025
10659,11/06/2025
10751,11/06/2025
10762,11/06/2025
10805,11/06/2025
10871,11/06/2025
10885,11/06/2025
10938,11/06/2025
11001,11/06/2025
11072,11/06/2025
11200,11/06/2025
11229,11/06/2025
11267,11/06/2025
11322,11/06/2025
11336,11/06/2025
11365,11/06/2025
11397,11/06/2025
11420,11/06/2025
11421,11/06/2025
857,10/06/2025
944,10/06/2025
1054,10/06/2025
2224,10/06/2025
2482,10/06/2025
3213,10/06/2025
3342,10/06/2025
3468,10/06/2025
3625,10/06/2025
3843,10/06/2025
4864,10/06/2025
5317,10/06/2025
5404,10/06/2025
5663,10/06/2025
6532,10/06/2025
7064,10/06/2025
7438,10/06/2025
9137,10/06/2025
9192,10/06/2025
9413,10/06/2025
9541,10/06/2025
9583,10/06/2025
9625,10/06/2025
10244,10/06/2025
10267,10/06/2025
10473,10/06/2025
10579,10/06/2025
10659,10/06/2025
10751,10/06/2025
10762,10/06/2025
10805,10/06/2025
10871,10/06/2025
10885,10/06/2025
10938,10/06/2025
11001,10/06/2025
11072,10/06/2025
11200,10/06/2025
11229,10/06/2025
11267,10/06/2025
11322,10/06/2025
11336,10/06/2025
11365,10/06/2025
11397,10/06/2025
11420,10/06/2025
11421,10/06/2025
857,09/06/2025
944,09/06/2025
1054,09/06/2025
2224,09/06/2025
2482,09/06/2025
3213,09/06/2025
3342,09/06/2025
3468,09/06/2025
3625,09/06/2025
3843,09/06/2025
4864,09/06/2025
5317,09/06/2025
5404,09/06/2025
5663,09/06/2025
6532,09/06/2025
7064,09/06/2025
7438,09/06/2025
9137,09/06/2025
9192,09/06/2025
9413,09/06/2025
9541,09/06/2025
9583,09/06/2025
9625,09/06/2025
10244,09/06/2025
10267,09/06/2025
10473,09/06/2025
10579,09/06/2025
10659,09/06/2025
10751,09/06/2025
10762,09/06/2025
10805,09/06/2025
10871,09/06/2025
10885,09/06/2025
10938,09/06/2025
11001,09/06/2025
11072,09/06/2025
11200,09/06/2025
11229,09/06/2025
11267,09/06/2025
11322,09/06/2025
11336,09/06/2025
11365,09/06/2025
11397,09/06/2025
11420,09/06/2025
11421,09/06/2025
857,08/06/2025
944,08/06/2025
1054,08/06/2025
2224,08/06/2025
2482,08/06/2025
3213,08/06/2025
3342,08/06/2025
3468,08/06/2025
3625,08/06/2025
3843,08/06/2025
4864,08/06/2025
5317,08/06/2025
5404,08/06/2025
5663,08/06/2025
6532,08/06/2025
7064,08/06/2025
7438,08/06/2025
9137,08/06/2025
9192,08/06/2025
9413,08/06/2025
9541,08/06/2025
9583,08/06/2025
9625,08/06/2025
10244,08/06/2025
10267,08/06/2025
10473,08/06/2025
10579,08/06/2025
10659,08/06/2025
10751,08/06/2025
10762,08/06/2025
10805,08/06/2025
10871,08/06/2025
10885,08/06/2025
10938,08/06/2025
11001,08/06/2025
11072,08/06/2025
11200,08/06/2025
11229,08/06/2025
11267,08/06/2025
11322,08/06/2025
11336,08/06/2025
11365,08/06/2025
11397,08/06/2025
11420,08/06/2025
11421,08/06/2025
857,07/06/2025
944,07/06/2025
1054,07/06/2025
2224,07/06/2025
2482,07/06/2025
3213,07/06/2025
3342,07/06/2025
3468,07/06/2025
3625,07/06/2025
3843,07/06/2025
4864,07/06/2025
5317,07/06/2025
5404,07/06/2025
5663,07/06/2025
6532,07/06/2025
7064,07/06/2025
7438,07/06/2025
9137,07/06/2025
9192,07/06/2025
9413,07/06/2025
9541,07/06/2025
9583,07/06/2025
9625,07/06/2025
10244,07/06/2025
10267,07/06/2025
10473,07/06/2025
10579,07/06/2025
10659,07/06/2025
10751,07/06/2025
10762,07/06/2025
10805,07/06/2025
10871,07/06/2025
10885,07/06/2025
10938,07/06/2025
11001,07/06/2025
11072,07/06/2025
11200,07/06/2025
11229,07/06/2025
11267,07/06/2025
11322,07/06/2025
11336,07/06/2025
11365,07/06/2025
11397,07/06/2025
11420,07/06/2025
11421,07/06/2025
857,06/06/2025
944,06/06/2025
1054,06/06/2025
2224,06/06/2025
2482,06/06/2025
3213,06/06/2025
3342,06/06/2025
3468,06/06/2025
3625,06/06/2025
3843,06/06/2025
4864,06/06/2025
5317,06/06/2025
5404,06/06/2025
5663,06/06/2025
6532,06/06/2025
7064,06/06/2025
7438,06/06/2025
9137,06/06/2025
9192,06/06/2025
9413,06/06/2025
9541,06/06/2025
9583,06/06/2025
9625,06/06/2025
10244,06/06/2025
10267,06/06/2025
10473,06/06/2025
10579,06/06/2025
10659,06/06/2025
10751,06/06/2025
10762,06/06/2025
10805,06/06/2025
10871,06/06/2025
10885,06/06/2025
10938,06/06/2025
11001,06/06/2025
11072,06/06/2025
11200,06/06/2025
11229,06/06/2025
11267,06/06/2025
11322,06/06/2025
11336,06/06/2025
11365,06/06/2025
11397,06/06/2025
11420,06/06/2025
11421,06/06/2025
857,05/06/2025
944,05/06/2025
1054,05/06/2025
2224,05/06/2025
2482,05/06/2025
3213,05/06/2025
3342,05/06/2025
3468,05/06/2025
3625,05/06/2025
3843,05/06/2025
4864,05/06/2025
5317,05/06/2025
5404,05/06/2025
5663,05/06/2025
6532,05/06/2025
7064,05/06/2025
7438,05/06/2025
9137,05/06/2025
9192,05/06/2025
9413,05/06/2025
9541,05/06/2025
9583,05/06/2025
9625,05/06/2025
10244,05/06/2025
10267,05/06/2025
10473,05/06/2025
10579,05/06/2025
10659,05/06/2025
10751,05/06/2025
10762,05/06/2025
10805,05/06/2025
10871,05/06/2025
10885,05/06/2025
10938,05/06/2025
11001,05/06/2025
11072,05/06/2025
11200,05/06/2025
11229,05/06/2025
11267,05/06/2025
11322,05/06/2025
11336,05/06/2025
11365,05/06/2025
11397,05/06/2025
11420,05/06/2025
11421,05/06/2025
857,04/06/2025
944,04/06/2025
1054,04/06/2025
2224,04/06/2025
2482,04/06/2025
3213,04/06/2025
3342,04/06/2025
3468,04/06/2025
3625,04/06/2025
3843,04/06/2025
4864,04/06/2025
5317,04/06/2025
5404,04/06/2025
5663,04/06/2025
6532,04/06/2025
7064,04/06/2025
7438,04/06/2025
9137,04/06/2025
9192,04/06/2025
9413,04/06/2025
9541,04/06/2025
9583,04/06/2025
9625,04/06/2025
10244,04/06/2025
10267,04/06/2025
10473,04/06/2025
10579,04/06/2025
10659,04/06/2025
10751,04/06/2025
10762,04/06/2025
10805,04/06/2025
10871,04/06/2025
10885,04/06/2025
10938,04/06/2025
11001,04/06/2025
11072,04/06/2025
11200,04/06/2025
11229,04/06/2025
11267,04/06/2025
11322,04/06/2025
11336,04/06/2025
11365,04/06/2025
11397,04/06/2025
11420,04/06/2025
11421,04/06/2025
857,03/06/2025
944,03/06/2025
1054,03/06/2025
2224,03/06/2025
2482,03/06/2025
3213,03/06/2025
3342,03/06/2025
3468,03/06/2025
3625,03/06/2025
3843,03/06/2025
4864,03/06/2025
5317,03/06/2025
5404,03/06/2025
5663,03/06/2025
6532,03/06/2025
7064,03/06/2025
7438,03/06/2025
9137,03/06/2025
9192,03/06/2025
9413,03/06/2025
9541,03/06/2025
9583,03/06/2025
9625,03/06/2025
10244,03/06/2025
10267,03/06/2025
10473,03/06/2025
10579,03/06/2025
10659,03/06/2025
10751,03/06/2025
10762,03/06/2025
10805,03/06/2025
10871,03/06/2025
10885,03/06/2025
10938,03/06/2025
11001,03/06/2025
11072,03/06/2025
11200,03/06/2025
11229,03/06/2025
11267,03/06/2025
11322,03/06/2025
11336,03/06/2025
11365,03/06/2025
11397,03/06/2025
11420,03/06/2025
11421,03/06/2025
857,02/06/2025
944,02/06/2025
1054,02/06/2025
2224,02/06/2025
2482,02/06/2025
3213,02/06/2025
3342,02/06/2025
3468,02/06/2025
3625,02/06/2025
3843,02/06/2025
4864,02/06/2025
5317,02/06/2025
5404,02/06/2025
5663,02/06/2025
6532,02/06/2025
7064,02/06/2025
7438,02/06/2025
9137,02/06/2025
9192,02/06/2025
9413,02/06/2025
9541,02/06/2025
9583,02/06/2025
9625,02/06/2025
10244,02/06/2025
10267,02/06/2025
10473,02/06/2025
10579,02/06/2025
10659,02/06/2025
10751,02/06/2025
10762,02/06/2025
10805,02/06/2025
10871,02/06/2025
10885,02/06/2025
10938,02/06/2025
11001,02/06/2025
11072,02/06/2025
11200,02/06/2025
11229,02/06/2025
11267,02/06/2025
11322,02/06/2025
11336,02/06/2025
11365,02/06/2025
11397,02/06/2025
11420,02/06/2025
11421,02/06/2025
857,01/06/2025
944,01/06/2025
1054,01/06/2025
2224,01/06/2025
2482,01/06/2025
3213,01/06/2025
3342,01/06/2025
3468,01/06/2025
3625,01/06/2025
3843,01/06/2025
4864,01/06/2025
5317,01/06/2025
5404,01/06/2025
5663,01/06/2025
6532,01/06/2025
7064,01/06/2025
7438,01/06/2025
9137,01/06/2025
9192,01/06/2025
9413,01/06/2025
9541,01/06/2025
9583,01/06/2025
9625,01/06/2025
10244,01/06/2025
10267,01/06/2025
10473,01/06/2025
10579,01/06/2025
10659,01/06/2025
10751,01/06/2025
10762,01/06/2025
10805,01/06/2025
10871,01/06/2025
10885,01/06/2025
10938,01/06/2025
11001,01/06/2025
11072,01/06/2025
11200,01/06/2025
11229,01/06/2025
11267,01/06/2025
11322,01/06/2025
11336,01/06/2025
11365,01/06/2025
11397,01/06/2025
11420,01/06/2025
11421,01/06/2025
857,31/05/2025
944,31/05/2025
1054,31/05/2025
2224,31/05/2025
2482,31/05/2025
3213,31/05/2025
3342,31/05/2025
3468,31/05/2025
3625,31/05/2025
3843,31/05/2025
4864,31/05/2025
5317,31/05/2025
5404,31/05/2025
5663,31/05/2025
6532,31/05/2025
7064,31/05/2025
7438,31/05/2025
9137,31/05/2025
9192,31/05/2025
9413,31/05/2025
9541,31/05/2025
9583,31/05/2025
9625,31/05/2025
10244,31/05/2025
10267,31/05/2025
10473,31/05/2025
10579,31/05/2025
10659,31/05/2025
10751,31/05/2025
10762,31/05/2025
10805,31/05/2025
10871,31/05/2025
10885,31/05/2025
10938,31/05/2025
11001,31/05/2025
11072,31/05/2025
11200,31/05/2025
11229,31/05/2025
11267,31/05/2025
11322,31/05/2025
11336,31/05/2025
11365,31/05/2025
11397,31/05/2025
11420,31/05/2025
11421,31/05/2025`;

        // Touchpoint definitions
        const touchpoints = {
            '3months': { name: '3 Month Follow-up', lookback: 90 },
            '5months': { name: '5 Month Follow-up', lookback: 150 },
            '6months': { name: '6 Month Follow-up', lookback: 180 },
            '9months': { name: '9 Month Follow-up', lookback: 270 },
            '12months': { name: '12 Month Follow-up', lookback: 365 },
            '18months': { name: '18 Month Follow-up', lookback: 540 },
            '24months': { name: '24 Month Follow-up', lookback: 720 }
        };

        // Parse DD/MM/YYYY date format correctly
        function parseAustralianDate(dateString) {
            if (!dateString) return null;
            
            const cleanDate = dateString.split(' ')[0];
            const parts = cleanDate.split('/');
            
            if (parts.length !== 3) return null;
            
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            
            return new Date(year, month, day);
        }

        // Simple CSV parser
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const data = lines.map(line => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim().replace(/"/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim().replace(/"/g, ''));
                return result;
            });
            
            return { data: data, errors: [] };
        }

        // Load embedded data automatically on page load
        function loadEmbeddedData() {
            console.log('🚀 Loading pre-embedded clinic data...');
            
            // Simulate loading time for better UX
            setTimeout(() => {
                processCsvData(embeddedCsvData);
            }, 1000);
        }

        // Export conversion results
        function exportConversionResults() {
            if (Object.keys(conversionResults).length === 0) {
                alert('No conversion results to export. Please wait for calculations to complete.');
                return;
            }
            
            let csvContent = 'Touchpoint,Month,Available Conversions,Conversions,Conversion Rate\n';
            
            Object.keys(touchpoints).forEach(touchpointKey => {
                const touchpointName = touchpoints[touchpointKey].name;
                const results = conversionResults[touchpointKey] || [];
                
                results.forEach(result => {
                    csvContent += `"${touchpointName}","${result.month}",${result.remindersSent},${result.conversions},"${result.conversionRate}%"\n`;
                });
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'conversion_analysis_results.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('📤 Conversion results exported successfully');
            } else {
                alert('Your browser does not support file downloads');
            }
        }

        // Process CSV data
        function processCsvData(csvText) {
            console.log('📊 Processing clinic data...');
            
            try {
                const parsed = parseCSV(csvText);
                
                parsedData = parsed.data.map(row => ({
                    INTERNALID: row[0],
                    APPOINTMENTDATE: row[1]
                })).filter(row => row.INTERNALID && row.APPOINTMENTDATE);

                console.log(`✅ Processed ${parsedData.length} appointments`);

                // Hide loading, show data status
                document.getElementById('loadingStatus').classList.add('hidden');
                document.getElementById('dataStatus').classList.remove('hidden');
                
                calculateAllConversions();
                
            } catch (error) {
                console.error('❌ Error processing data:', error);
                document.getElementById('loadingStatus').innerHTML = `
                    <div style="color: #dc2626;">
                        ❌ Error loading data: ${error.message}
                    </div>
                `;
            }
        }

        // Calculate conversions for all touchpoints
        function calculateAllConversions() {
            console.log('🔄 Calculating conversion rates...');
            
            conversionResults = {};

            Object.keys(touchpoints).forEach(touchpointKey => {
                const touchpoint = touchpoints[touchpointKey];
                const monthlyResults = {};
                
                const allDates = [...new Set(parsedData.map(row => row.APPOINTMENTDATE))];
                
                allDates.forEach(todayDate => {
                    try {
                        const today = parseAustralianDate(todayDate);
                        if (!today || isNaN(today.getTime())) return;

                        const referenceDate = new Date(today);
                        referenceDate.setDate(referenceDate.getDate() - touchpoint.lookback);

                        // Find patients who had appointment exactly on reference date
                        const eligiblePatients = parsedData.filter(row => {
                            const appointmentDate = parseAustralianDate(row.APPOINTMENTDATE);
                            if (!appointmentDate) return false;
                            return appointmentDate.toDateString() === referenceDate.toDateString();
                        });

                        // Remove patients who already rebooked between reference date and today
                        const patientsNeedingReminder = eligiblePatients.filter(patient => {
                            const patientId = patient.INTERNALID;
                            const hasRebookedAlready = parsedData.some(row => {
                                if (row.INTERNALID !== patientId) return false;
                                const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                                if (!apptDate) return false;
                                return apptDate > referenceDate && apptDate < today;
                            });
                            return !hasRebookedAlready;
                        });

                        // Check for conversions (appointments within 30 days after today)
                        const conversions = patientsNeedingReminder.filter(patient => {
                            const patientId = patient.INTERNALID;
                            const conversionWindowEnd = new Date(today);
                            conversionWindowEnd.setDate(conversionWindowEnd.getDate() + 30);

                            return parsedData.some(row => {
                                if (row.INTERNALID !== patientId) return false;
                                const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                                if (!apptDate) return false;
                                return apptDate > today && apptDate <= conversionWindowEnd;
                            });
                        });

                        // Group by month
                        const monthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

                        if (!monthlyResults[monthKey]) {
                            monthlyResults[monthKey] = { remindersSent: 0, conversions: 0, month: monthKey };
                        }

                        monthlyResults[monthKey].remindersSent += patientsNeedingReminder.length;
                        monthlyResults[monthKey].conversions += conversions.length;

                    } catch (error) {
                        console.error(`Error processing date "${todayDate}":`, error);
                    }
                });

                // Calculate conversion rates
                Object.keys(monthlyResults).forEach(month => {
                    const result = monthlyResults[month];
                    result.conversionRate = result.remindersSent > 0 
                        ? (result.conversions / result.remindersSent * 100).toFixed(1)
                        : '0.0';
                });

                conversionResults[touchpointKey] = Object.values(monthlyResults).sort((a, b) => a.month.localeCompare(b.month));
            });

            console.log('✅ Conversion analysis complete!');
            updateMonthButtons();
            updateDisplay();
            updateConversionChart();
            
            // Enable export button
            document.getElementById('exportDataBtn').disabled = false;
        }

        // Update month filter buttons
        function updateMonthButtons() {
            const months = new Set();
            Object.values(conversionResults).forEach(touchpointData => {
                touchpointData.forEach(result => months.add(result.month));
            });

            const monthButtons = document.getElementById('monthButtons');
            monthButtons.innerHTML = '<button class="button purple active" data-month="all">All Months</button>';

            Array.from(months).sort().forEach(month => {
                const button = document.createElement('button');
                button.className = 'button purple';
                button.dataset.month = month;
                button.textContent = month;
                monthButtons.appendChild(button);
            });

            monthButtons.removeEventListener('click', handleMonthButtonClick);
            monthButtons.addEventListener('click', handleMonthButtonClick);
        }

        // Month button click handler
        function handleMonthButtonClick(e) {
            if (e.target.dataset.month) {
                selectedMonth = e.target.dataset.month;
                updateDisplay();
            }
        }

        // Create conversion trend chart
        function updateConversionChart() {
            const currentResults = conversionResults[selectedTouchpoint] || [];
            const chartContainer = document.getElementById('conversionChart');
            const chartTitle = document.getElementById('chartTitle');
            
            chartTitle.textContent = `Conversion Rate Trend - ${touchpoints[selectedTouchpoint].name}`;
            
            if (currentResults.length === 0) {
                chartContainer.innerHTML = '<div style="color: #6b7280;">No data available for chart</div>';
                return;
            }
            
            const width = chartContainer.offsetWidth || 800;
            const height = 300;
            const margin = { top: 20, right: 30, bottom: 60, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            const data = currentResults.map(result => ({
                month: result.month,
                rate: parseFloat(result.conversionRate)
            }));
            
            const maxRate = Math.max(...data.map(d => d.rate));
            const yMax = Math.max(maxRate * 1.1, 5);
            
            let svg = `
                <svg width="${width}" height="${height}" style="background: white;">
                    <defs>
                        <pattern id="grid" width="40" height="30" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 30" fill="none" stroke="#f1f5f9" stroke-width="1"/>
                        </pattern>
                    </defs>
                    <rect x="${margin.left}" y="${margin.top}" width="${chartWidth}" height="${chartHeight}" fill="url(#grid)" />
                    
                    <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + chartHeight}" stroke="#d1d5db" stroke-width="2"/>
                    <line x1="${margin.left}" y1="${margin.top + chartHeight}" x2="${margin.left + chartWidth}" y2="${margin.top + chartHeight}" stroke="#d1d5db" stroke-width="2"/>
            `;
            
            for (let i = 0; i <= 5; i++) {
                const yValue = (yMax / 5) * i;
                const y = margin.top + chartHeight - (i / 5) * chartHeight;
                svg += `
                    <text x="${margin.left - 10}" y="${y + 5}" text-anchor="end" font-size="12" fill="#6b7280">
                        ${yValue.toFixed(1)}%
                    </text>
                    <line x1="${margin.left - 5}" y1="${y}" x2="${margin.left}" y2="${y}" stroke="#d1d5db" stroke-width="1"/>
                `;
            }
            
            const points = [];
            data.forEach((d, index) => {
                const x = data.length === 1 ? margin.left + chartWidth / 2 : margin.left + (index / (data.length - 1)) * chartWidth;
                const y = margin.top + chartHeight - (d.rate / yMax) * chartHeight;
                
                points.push(`${x},${y}`);
                
                svg += `
                    <text x="${x}" y="${margin.top + chartHeight + 20}" text-anchor="middle" font-size="11" fill="#6b7280">
                        ${d.month}
                    </text>
                    <circle cx="${x}" cy="${y}" r="4" fill="#2563eb" stroke="white" stroke-width="2"/>
                    <text x="${x}" y="${y - 10}" text-anchor="middle" font-size="10" fill="#1f2937" font-weight="600">
                        ${d.rate}%
                    </text>
                `;
            });
            
            if (points.length > 1) {
                svg += `<polyline points="${points.join(' ')}" fill="none" stroke="#2563eb" stroke-width="3" stroke-linecap="round"/>`;
            }
            
            svg += `
                <text x="20" y="${margin.top + chartHeight / 2}" text-anchor="middle" font-size="14" fill="#374151" font-weight="600" transform="rotate(-90, 20, ${margin.top + chartHeight / 2})">
                    Conversion Rate (%)
                </text>
                <text x="${margin.left + chartWidth / 2}" y="${height - 10}" text-anchor="middle" font-size="14" fill="#374151" font-weight="600">
                    Month
                </text>
            `;
            
            svg += '</svg>';
            chartContainer.innerHTML = svg;
        }

        // Update display
        function updateDisplay() {
            const currentResults = conversionResults[selectedTouchpoint] || [];
            const filteredResults = selectedMonth === 'all' 
                ? currentResults 
                : currentResults.filter(result => result.month === selectedMonth);

            const totalReminders = filteredResults.reduce((sum, r) => sum + r.remindersSent, 0);
            const totalConversions = filteredResults.reduce((sum, r) => sum + r.conversions, 0);
            const overallRate = totalReminders > 0 ? (totalConversions / totalReminders * 100).toFixed(1) : '0.0';

            document.getElementById('totalReminders').textContent = totalReminders.toLocaleString();
            document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
            document.getElementById('overallRate').textContent = overallRate + '%';

            updateResultsTable(filteredResults);
            updateButtonStates();
            updateConversionChart();
        }

        // Update results table
        function updateResultsTable(results) {
            const container = document.getElementById('resultsTable');
            
            if (results.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6b7280;">No data available for the selected touchpoint and month</div>';
                return;
            }

            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="text-right">Available Conversions</th>
                                <th class="text-right">Conversions</th>
                                <th class="text-right">Conversion Rate</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach(result => {
                const rate = parseFloat(result.conversionRate);
                const rateClass = rate >= 20 ? 'rate-high' : rate >= 10 ? 'rate-medium' : 'rate-low';
                
                tableHTML += `
                    <tr class="zebra">
                        <td>${result.month}</td>
                        <td class="text-right">${result.remindersSent.toLocaleString()}</td>
                        <td class="text-right">${result.conversions.toLocaleString()}</td>
                        <td class="text-right">
                            <span class="conversion-rate ${rateClass}">${result.conversionRate}%</span>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        // Update button states
        function updateButtonStates() {
            document.querySelectorAll('[data-touchpoint]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.touchpoint === selectedTouchpoint);
            });
            document.querySelectorAll('[data-month]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.month === selectedMonth);
            });
            document.getElementById('currentTouchpointLabel').textContent = `(${touchpoints[selectedTouchpoint].name})`;
        }

        // Touchpoint button click handler
        function handleTouchpointButtonClick(e) {
            if (e.target.dataset.touchpoint) {
                selectedTouchpoint = e.target.dataset.touchpoint;
                updateDisplay();
            }
        }

        // Event listeners
        document.getElementById('exportDataBtn').addEventListener('click', exportConversionResults);
        
        document.getElementById('touchpointButtons').addEventListener('click', handleTouchpointButtonClick);

        // Initialize on page load
        updateButtonStates();
        loadEmbeddedData();
        
        window.addEventListener('resize', function() {
            if (Object.keys(conversionResults).length > 0) {
                setTimeout(updateConversionChart, 100);
            }
        });
        
        console.log('🚀 Dashboard initialized with pre-loaded clinic data');
    </script>
</body>
</html>

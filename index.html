<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Follow-Up Conversion Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .header p {
            color: #6b7280;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .icon {
            width: 20px;
            height: 20px;
            color: #2563eb;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .file-upload input {
            margin-bottom: 8px;
        }

        .status-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .button {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 14px;
        }

        .button:hover {
            border-color: #3b82f6;
        }

        .button.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .button.purple {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }

        .button.purple:not(.active) {
            background: white;
            color: #374151;
        }

        .button.purple:not(.active):hover {
            border-color: #7c3aed;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 4px;
        }

        .summary-label {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            font-weight: 600;
        }

        .text-right {
            text-align: right;
        }

        .conversion-rate {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }

        .rate-high { background: #dcfce7; color: #166534; }
        .rate-medium { background: #fef3c7; color: #92400e; }
        .rate-low { background: #fee2e2; color: #991b1b; }

        .zebra:nth-child(even) {
            background: #f9fafb;
        }

        .insights {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        @media (max-width: 768px) {
            .button-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }

        .filter-info {
            background: #f3e8ff;
            border: 1px solid #c4b5fd;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 14px;
            color: #5b21b6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Follow-Up Conversion Dashboard</h1>
            <p>Track conversion rates for SMS follow-up touchpoints across your patient journey</p>
        </div>

        <!-- Data Upload Section -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h2>Data Upload</h2>
            </div>
            <div class="file-upload">
                <input type="file" id="csvFile" accept=".csv" />
                <div id="uploadStatus" style="margin-top: 8px; padding: 8px; border-radius: 4px; display: none;">
                    <div id="processingStatus" style="color: #2563eb;">
                        🔄 Processing file...
                    </div>
                </div>
                <p style="font-size: 14px; color: #6b7280; margin-top: 8px;">
                    Upload your clinic CSV file<br>
                    <strong>Column A</strong> = Patient IDs (INTERNALID)<br>
                    <strong>Column J</strong> = Appointment Dates (APPOINTMENTDATE)
                </p>
            </div>
            <div id="dataStatus" class="hidden">
                <div class="status-success">
                    <div style="display: flex; align-items: center; gap: 8px; color: #166534; margin-bottom: 8px;">
                        <span style="font-size: 18px;">✅</span>
                        <span style="font-weight: 600;">Clinic Data Loaded Successfully</span>
                    </div>
                    <div class="status-grid">
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Total Appointments:</span><br>
                            <span id="totalAppointments" style="font-weight: bold; color: #15803d;">0</span>
                        </div>
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Unique Patients:</span><br>
                            <span id="uniquePatients" style="font-weight: bold; color: #15803d;">0</span>
                        </div>
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Date Range:</span><br>
                            <span style="font-weight: bold; color: #15803d;">1 Year Sample</span>
                        </div>
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Return Rate:</span><br>
                            <span id="returnRate" style="font-weight: bold; color: #15803d;">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Touchpoint Selection -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <h2>Follow-Up Touchpoint</h2>
            </div>
            <div class="button-grid" id="touchpointButtons">
                <button class="button active" data-touchpoint="2weeks">
                    <div style="font-weight: 500;">2 Week Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">14 days</div>
                </button>
                <button class="button" data-touchpoint="6weeks">
                    <div style="font-weight: 500;">6 Week Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">42 days</div>
                </button>
                <button class="button" data-touchpoint="3months">
                    <div style="font-weight: 500;">3 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">90 days</div>
                </button>
                <button class="button" data-touchpoint="5months">
                    <div style="font-weight: 500;">5 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">150 days</div>
                </button>
                <button class="button" data-touchpoint="6months">
                    <div style="font-weight: 500;">6 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">180 days</div>
                </button>
                <button class="button" data-touchpoint="12months">
                    <div style="font-weight: 500;">12 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">365 days</div>
                </button>
            </div>
        </div>

        <!-- Month Filter -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #7c3aed;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <h2>Month Filter</h2>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="monthButtons">
                <button class="button purple active" data-month="all">All Months</button>
            </div>
            <div id="monthFilterInfo" class="filter-info hidden">
                📅 Viewing results for: <strong id="selectedMonthText"></strong>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card">
                <div>
                    <div class="summary-label">Reminders Sent</div>
                    <div class="summary-value" id="totalReminders">0</div>
                </div>
                <svg style="width: 32px; height: 32px; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-.5a6 6 0 01-3 5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
            </div>
            <div class="summary-card">
                <div>
                    <div class="summary-label">Conversions</div>
                    <div class="summary-value" id="totalConversions">0</div>
                </div>
                <svg style="width: 32px; height: 32px; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
            </div>
            <div class="summary-card">
                <div>
                    <div class="summary-label">Conversion Rate</div>
                    <div class="summary-value" id="overallRate">0%</div>
                </div>
                <svg style="width: 32px; height: 32px; color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <h2>Conversion Results</h2>
                <span style="font-size: 14px; color: #6b7280;" id="currentTouchpointLabel">(2 Week Follow-up)</span>
            </div>
            
            <div id="resultsTable">
                <div style="text-align: center; padding: 32px 0; color: #6b7280;">
                    Upload your CSV data to see conversion results
                </div>
            </div>
        </div>

        <!-- Insights -->
        <div class="insights">
            <h3 style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">Analysis Insights</h3>
            <div class="insights-grid">
                <div>
                    <h4 style="font-weight: 500; margin-bottom: 4px; color: #1e40af;">Conversion Logic:</h4>
                    <ul style="font-size: 14px; color: #1e40af;">
                        <li>• Looks back X days to find eligible patients</li>
                        <li>• Excludes patients who already rebooked</li>
                        <li>• Tracks 30-day conversion window</li>
                        <li>• Groups by calendar month</li>
                    </ul>
                </div>
                <div>
                    <h4 style="font-weight: 500; margin-bottom: 4px; color: #1e40af;">Your Data Mapping:</h4>
                    <ul style="font-size: 14px; color: #1e40af;">
                        <li>• <strong>Column A (position 0)</strong> = Patient IDs</li>
                        <li>• <strong>Column J (position 9)</strong> = Appointment Dates</li>
                        <li>• <strong>14,105 appointments</strong> expected</li>
                        <li>• <strong>7,124 unique patients</strong> expected</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Touchpoint definitions
        const touchpoints = {
            '2weeks': { name: '2 Week Follow-up', lookback: 14 },
            '6weeks': { name: '6 Week Follow-up', lookback: 42 },
            '3months': { name: '3 Month Follow-up', lookback: 90 },
            '5months': { name: '5 Month Follow-up', lookback: 150 },
            '6months': { name: '6 Month Follow-up', lookback: 180 },
            '12months': { name: '12 Month Follow-up', lookback: 365 }
        };

        // Global variables
        let parsedData = [];
        let conversionResults = {};
        let selectedTouchpoint = '2weeks';
        let selectedMonth = 'all';

        // File upload handler
        document.getElementById('csvFile').addEventListener('change', function(event) {
            console.log('File selected:', event.target.files[0]);
            const file = event.target.files[0];
            
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }
            
            console.log('Reading file:', file.name, 'Size:', file.size);
            
            // Show processing status
            const uploadStatus = document.getElementById('uploadStatus');
            const processingStatus = document.getElementById('processingStatus');
            uploadStatus.style.display = 'block';
            processingStatus.textContent = '🔄 Reading file...';
            processingStatus.style.color = '#2563eb';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('File read successfully, length:', e.target.result.length);
                processingStatus.textContent = '🔄 Processing data...';
                
                // Small delay to show the status update
                setTimeout(() => {
                    processCsvData(e.target.result);
                }, 100);
            };
            reader.onerror = function(e) {
                console.error('Error reading file:', e);
                processingStatus.textContent = '❌ Error reading file';
                processingStatus.style.color = '#dc2626';
                alert('Error reading file. Please try again.');
            };
            reader.readAsText(file);
        });

        // Process CSV data
        function processCsvData(csvText) {
            console.log('Processing CSV data...');
            console.log('CSV preview (first 500 chars):', csvText.substring(0, 500));
            
            const uploadStatus = document.getElementById('uploadStatus');
            const processingStatus = document.getElementById('processingStatus');
            
            try {
                // Use our fallback-enabled parser
                const parsed = parseCSV(csvText);

                console.log('CSV Parse results:', parsed);
                console.log('Number of rows parsed:', parsed.data.length);
                
                if (parsed.errors && parsed.errors.length > 0) {
                    console.warn('Parse errors:', parsed.errors);
                }

                // Map to your actual column positions: A=0, J=9
                parsedData = parsed.data.map((row, index) => {
                    if (index < 3) {
                        console.log(`Row ${index}:`, row);
                        console.log(`Patient ID (col 0):`, row[0], `Appointment Date (col 9):`, row[9]);
                    }
                    return {
                        INTERNALID: row[0],      // Column A
                        APPOINTMENTDATE: row[9]  // Column J
                    };
                }).filter(row => {
                    return row.INTERNALID && row.APPOINTMENTDATE;
                });

                console.log('Filtered data length:', parsedData.length);
                console.log('Sample filtered data:', parsedData.slice(0, 3));

                if (parsedData.length > 0) {
                    processingStatus.textContent = '✅ Data loaded successfully!';
                    processingStatus.style.color = '#16a34a';
                    
                    console.log('Updating data status...');
                    updateDataStatus();
                    console.log('Calculating conversions...');
                    calculateAllConversions();
                    console.log('Updating display...');
                    updateDisplay();
                    console.log('Data processing complete!');
                    
                    // Hide processing status after a moment
                    setTimeout(() => {
                        uploadStatus.style.display = 'none';
                    }, 2000);
                } else {
                    console.error('No valid data found after filtering');
                    processingStatus.textContent = '❌ No valid data found';
                    processingStatus.style.color = '#dc2626';
                    alert('No valid data found. Please check that your CSV has data in columns A (Patient IDs) and J (Appointment Dates).\n\nMake sure:\n- Column A has patient IDs\n- Column J has appointment dates\n- File is in CSV format');
                }
            } catch (error) {
                console.error('Error processing CSV:', error);
                processingStatus.textContent = '❌ Processing error';
                processingStatus.style.color = '#dc2626';
                alert('Error processing CSV file: ' + error.message);
            }
        }

        // Update data status display
        function updateDataStatus() {
            const uniquePatients = new Set(parsedData.map(r => r.INTERNALID)).size;
            const patientCounts = {};
            parsedData.forEach(row => {
                patientCounts[row.INTERNALID] = (patientCounts[row.INTERNALID] || 0) + 1;
            });
            const returnPatients = Object.values(patientCounts).filter(count => count > 1).length;
            const returnRate = Math.round((returnPatients / uniquePatients) * 100);

            document.getElementById('totalAppointments').textContent = parsedData.length.toLocaleString();
            document.getElementById('uniquePatients').textContent = uniquePatients.toLocaleString();
            document.getElementById('returnRate').textContent = returnRate + '%';
            document.getElementById('dataStatus').classList.remove('hidden');
        }

        // Calculate conversions for all touchpoints
        function calculateAllConversions() {
            conversionResults = {};

            Object.keys(touchpoints).forEach(touchpointKey => {
                const touchpoint = touchpoints[touchpointKey];
                const monthlyResults = {};

                const allDates = [...new Set(parsedData.map(row => row.APPOINTMENTDATE))];

                allDates.forEach(todayDate => {
                    try {
                        const today = new Date(todayDate);
                        if (isNaN(today.getTime())) return;

                        const referenceDate = new Date(today);
                        referenceDate.setDate(referenceDate.getDate() - touchpoint.lookback);

                        const eligiblePatients = parsedData.filter(row => {
                            const appointmentDate = new Date(row.APPOINTMENTDATE);
                            return appointmentDate.toDateString() === referenceDate.toDateString();
                        });

                        const patientsNeedingReminder = eligiblePatients.filter(patient => {
                            const patientId = patient.INTERNALID;
                            return !parsedData.some(row => {
                                if (row.INTERNALID !== patientId) return false;
                                const apptDate = new Date(row.APPOINTMENTDATE);
                                return apptDate > referenceDate && apptDate < today;
                            });
                        });

                        const conversions = patientsNeedingReminder.filter(patient => {
                            const patientId = patient.INTERNALID;
                            const conversionWindowEnd = new Date(today);
                            conversionWindowEnd.setDate(conversionWindowEnd.getDate() + 30);

                            return parsedData.some(row => {
                                if (row.INTERNALID !== patientId) return false;
                                const apptDate = new Date(row.APPOINTMENTDATE);
                                return apptDate > today && apptDate <= conversionWindowEnd;
                            });
                        });

                        const monthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

                        if (!monthlyResults[monthKey]) {
                            monthlyResults[monthKey] = { remindersSent: 0, conversions: 0, month: monthKey };
                        }

                        monthlyResults[monthKey].remindersSent += patientsNeedingReminder.length;
                        monthlyResults[monthKey].conversions += conversions.length;

                    } catch (error) {
                        console.error('Error processing date:', todayDate);
                    }
                });

                Object.keys(monthlyResults).forEach(month => {
                    const result = monthlyResults[month];
                    result.conversionRate = result.remindersSent > 0 
                        ? (result.conversions / result.remindersSent * 100).toFixed(1)
                        : '0.0';
                });

                conversionResults[touchpointKey] = Object.values(monthlyResults).sort((a, b) => a.month.localeCompare(b.month));
            });

            updateMonthButtons();
        }

        // Update month filter buttons
        function updateMonthButtons() {
            const months = new Set();
            Object.values(conversionResults).forEach(touchpointData => {
                touchpointData.forEach(result => months.add(result.month));
            });

            const monthButtons = document.getElementById('monthButtons');
            monthButtons.innerHTML = '<button class="button purple active" data-month="all">All Months</button>';

            Array.from(months).sort().forEach(month => {
                const button = document.createElement('button');
                button.className = 'button purple';
                button.dataset.month = month;
                button.textContent = month;
                monthButtons.appendChild(button);
            });

            // Add event listeners to month buttons
            monthButtons.addEventListener('click', function(e) {
                if (e.target.dataset.month) {
                    selectedMonth = e.target.dataset.month;
                    updateMonthButtonStates();
                    updateDisplay();
                }
            });
        }

        // Update button states
        function updateTouchpointButtonStates() {
            document.querySelectorAll('[data-touchpoint]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.touchpoint === selectedTouchpoint);
            });
            document.getElementById('currentTouchpointLabel').textContent = `(${touchpoints[selectedTouchpoint].name})`;
        }

        function updateMonthButtonStates() {
            document.querySelectorAll('[data-month]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.month === selectedMonth);
            });

            const filterInfo = document.getElementById('monthFilterInfo');
            if (selectedMonth === 'all') {
                filterInfo.classList.add('hidden');
            } else {
                filterInfo.classList.remove('hidden');
                document.getElementById('selectedMonthText').textContent = `${selectedMonth} (${touchpoints[selectedTouchpoint].name})`;
            }
        }

        // Update main display
        function updateDisplay() {
            const currentResults = conversionResults[selectedTouchpoint] || [];
            const filteredResults = selectedMonth === 'all' 
                ? currentResults 
                : currentResults.filter(result => result.month === selectedMonth);

            const totalReminders = filteredResults.reduce((sum, r) => sum + r.remindersSent, 0);
            const totalConversions = filteredResults.reduce((sum, r) => sum + r.conversions, 0);
            const overallRate = totalReminders > 0 ? (totalConversions / totalReminders * 100).toFixed(1) : '0.0';

            document.getElementById('totalReminders').textContent = totalReminders.toLocaleString();
            document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
            document.getElementById('overallRate').textContent = overallRate + '%';

            updateResultsTable(filteredResults);
        }

        // Update results table
        function updateResultsTable(results) {
            const container = document.getElementById('resultsTable');
            
            if (results.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6b7280;">No data available for the selected touchpoint and month</div>';
                return;
            }

            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="text-right">Reminders Sent</th>
                                <th class="text-right">Conversions</th>
                                <th class="text-right">Conversion Rate</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach((result, index) => {
                const rate = parseFloat(result.conversionRate);
                const rateClass = rate >= 20 ? 'rate-high' : rate >= 10 ? 'rate-medium' : 'rate-low';
                
                tableHTML += `
                    <tr class="zebra">
                        <td>${result.month}</td>
                        <td class="text-right">${result.remindersSent.toLocaleString()}</td>
                        <td class="text-right">${result.conversions.toLocaleString()}</td>
                        <td class="text-right">
                            <span class="conversion-rate ${rateClass}">${result.conversionRate}%</span>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        // Event listeners for touchpoint buttons
        document.getElementById('touchpointButtons').addEventListener('click', function(e) {
            if (e.target.dataset.touchpoint) {
                selectedTouchpoint = e.target.dataset.touchpoint;
                updateTouchpointButtonStates();
                updateDisplay();
            }
        });

        // Initialize
        updateTouchpointButtonStates();
        updateMonthButtonStates();
    </script>
</body>
</html>

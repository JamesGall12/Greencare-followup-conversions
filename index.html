<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannabis Clinic Business Intelligence Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .icon {
            width: 24px;
            height: 24px;
            color: #2563eb;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: #2563eb;
        }

        .file-upload input {
            margin-bottom: 12px;
        }

        .status-message {
            padding: 16px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 14px;
        }

        .status-info { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .status-success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .status-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: transform 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-2px);
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-top: 4px;
        }

        .summary-label {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .button {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 14px;
        }

        .button:hover {
            border-color: #3b82f6;
            transform: translateY(-1px);
        }

        .button.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .auto-button {
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 12px 8px;
            transition: background 0.2s;
        }

        .auto-button:hover {
            background: #1d4ed8;
        }

        .auto-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .auto-button.secondary {
            background: #7c3aed;
        }

        .auto-button.secondary:hover {
            background: #6d28d9;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            font-weight: 600;
            background: #f9fafb;
        }

        .text-right { text-align: right; }
        .text-center { text-align: center; }

        .zebra:nth-child(even) { background: #f9fafb; }

        .conversion-rate {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }

        .rate-high { background: #dcfce7; color: #166534; }
        .rate-medium { background: #fef3c7; color: #92400e; }
        .rate-low { background: #fee2e2; color: #991b1b; }

        .revenue-positive { color: #059669; font-weight: 600; }
        .revenue-negative { color: #dc2626; font-weight: 600; }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #2563eb;
        }

        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .metric-item {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .metric-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .hidden { display: none; }

        .executive-summary {
            background: linear-gradient(135deg, #1e40af, #7c3aed);
            color: white;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 32px;
        }

        .executive-summary h2 {
            font-size: 1.8rem;
            margin-bottom: 16px;
        }

        .exec-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .exec-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .exec-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .exec-label {
            font-size: 14px;
            opacity: 0.9;
        }

        @media (max-width: 768px) {
            .button-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Cannabis Clinic Business Intelligence</h1>
            <p>Complete operational analytics & conversion tracking for data-driven decision making</p>
        </div>

        <!-- Data Upload Section -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h2>Data Upload & Analysis</h2>
            </div>
            
            <div class="file-upload">
                <input type="file" id="csvFile" accept=".csv" />
                <div style="margin: 16px 0;">
                    <button id="exportDataBtn" class="auto-button" disabled>üìä Export Analysis Results</button>
                    <button id="executiveReportBtn" class="auto-button secondary" disabled>üìà Executive Summary Report</button>
                </div>
                <div id="statusMessage" class="hidden"></div>
                <p style="font-size: 14px; color: #6b7280; margin-top: 16px;">
                    <strong>Expected Columns:</strong> INTERNALID | DOB | SEX | BOOKEDBY | APPOINTMENTWITH | APPOINTMENTDATE | APPOINTMENTTYPE | APPOINTMENT_STATUS<br>
                    <strong>Revenue Model:</strong> Each follow-up conversion = $89 | New patients = $450 | Other appointments estimated
                </p>
            </div>
            
            <div id="dataStatus" class="hidden">
                <div class="status-success">
                    <div style="display: flex; align-items: center; gap: 8px; color: #166534; margin-bottom: 12px;">
                        <span style="font-size: 20px;">‚úÖ</span>
                        <span style="font-weight: 600; font-size: 16px;">Data Loaded & Processed Successfully</span>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-label">Total Records</div>
                            <div class="metric-value" id="totalRecords">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Completed Appointments</div>
                            <div class="metric-value" id="completedAppointments">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Unique Patients</div>
                            <div class="metric-value" id="uniquePatients">0</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Date Range</div>
                            <div class="metric-value" id="dateRange">-</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">No-Show Rate</div>
                            <div class="metric-value" id="noShowRate">0%</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Est. Revenue Impact</div>
                            <div class="metric-value revenue-positive" id="estimatedRevenue">$0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Executive Summary -->
        <div id="executiveSummary" class="executive-summary hidden">
            <h2>üìä Executive Performance Summary</h2>
            <p style="opacity: 0.9; margin-bottom: 20px;">Key business metrics & ROI opportunities</p>
            <div class="exec-grid">
                <div class="exec-item">
                    <div class="exec-value" id="execTotalRevenue">$0</div>
                    <div class="exec-label">Total Revenue Opportunity</div>
                </div>
                <div class="exec-item">
                    <div class="exec-value" id="execNoShowLoss">$0</div>
                    <div class="exec-label">Revenue Lost to No-Shows</div>
                </div>
                <div class="exec-item">
                    <div class="exec-value" id="execConversionRate">0%</div>
                    <div class="exec-label">Overall Follow-up Conversion</div>
                </div>
                <div class="exec-item">
                    <div class="exec-value" id="execTopChannel">-</div>
                    <div class="exec-label">Best Booking Channel</div>
                </div>
            </div>
        </div>

        <!-- Analysis Tabs -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" data-tab="conversions">Follow-up Conversions</button>
                <button class="tab" data-tab="practitioners">Practitioner Performance</button>
                <button class="tab" data-tab="channels">Booking Channels</button>
                <button class="tab" data-tab="locations">Location Analysis</button>
                <button class="tab" data-tab="demographics">Patient Demographics</button>
                <button class="tab" data-tab="revenue">Revenue Analysis</button>
            </div>

            <!-- Conversions Tab -->
            <div id="conversions" class="tab-content active">
                <div class="card-header">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <h2>Follow-Up Conversion Analysis</h2>
                </div>
                
                <div class="button-grid" id="touchpointButtons">
                    <button class="button" data-touchpoint="3months">
                        <div style="font-weight: 500;">3 Month Follow-up</div>
                        <div style="font-size: 12px; opacity: 0.7;">90 days</div>
                    </button>
                    <button class="button" data-touchpoint="5months">
                        <div style="font-weight: 500;">5 Month Follow-up</div>
                        <div style="font-size: 12px; opacity: 0.7;">150 days</div>
                    </button>
                    <button class="button active" data-touchpoint="6months">
                        <div style="font-weight: 500;">6 Month Follow-up</div>
                        <div style="font-size: 12px; opacity: 0.7;">180 days</div>
                    </button>
                    <button class="button" data-touchpoint="9months">
                        <div style="font-weight: 500;">9 Month Follow-up</div>
                        <div style="font-size: 12px; opacity: 0.7;">270 days</div>
                    </button>
                    <button class="button" data-touchpoint="12months">
                        <div style="font-weight: 500;">12 Month Follow-up</div>
                        <div style="font-size: 12px; opacity: 0.7;">365 days</div>
                    </button>
                </div>

                <div class="summary-grid">
                    <div class="summary-card">
                        <div>
                            <div class="summary-label">Available Conversions</div>
                            <div class="summary-value" id="totalReminders">0</div>
                        </div>
                        <svg style="width: 32px; height: 32px; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-.5a6 6 0 01-3 5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                    </div>
                    <div class="summary-card">
                        <div>
                            <div class="summary-label">Conversions</div>
                            <div class="summary-value" id="totalConversions">0</div>
                        </div>
                        <svg style="width: 32px; height: 32px; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                    <div class="summary-card">
                        <div>
                            <div class="summary-label">Conversion Rate</div>
                            <div class="summary-value" id="overallRate">0%</div>
                        </div>
                        <svg style="width: 32px; height: 32px; color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div class="summary-card">
                        <div>
                            <div class="summary-label">Revenue Recovery</div>
                            <div class="summary-value revenue-positive" id="conversionRevenue">$0</div>
                        </div>
                        <svg style="width: 32px; height: 32px; color: #059669;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                </div>

                <div id="conversionResults">
                    <div style="text-align: center; padding: 32px 0; color: #6b7280;">
                        Upload your CSV data to see conversion analysis
                    </div>
                </div>
            </div>

            <!-- Practitioners Tab -->
            <div id="practitioners" class="tab-content">
                <div class="card-header">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <h2>Practitioner Performance Analysis</h2>
                </div>
                <div id="practitionerResults">
                    <div style="text-align: center; padding: 32px 0; color: #6b7280;">
                        Upload your CSV data to see practitioner performance
                    </div>
                </div>
            </div>

            <!-- Channels Tab -->
            <div id="channels" class="tab-content">
                <div class="card-header">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <h2>Booking Channel Performance</h2>
                </div>
                <div id="channelResults">
                    <div style="text-align: center; padding: 32px 0; color: #6b7280;">
                        Upload your CSV data to see booking channel analysis
                    </div>
                </div>
            </div>

            <!-- Locations Tab -->
            <div id="locations" class="tab-content">
                <div class="card-header">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <h2>Location Performance Analysis</h2>
                </div>
                <div id="locationResults">
                    <div style="text-align: center; padding: 32px 0; color: #6b7280;">
                        Upload your CSV data to see location performance
                    </div>
                </div>
            </div>

            <!-- Demographics Tab -->
            <div id="demographics" class="tab-content">
                <div class="card-header">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <h2>Patient Demographics & Segmentation</h2>
                </div>
                <div id="demographicResults">
                    <div style="text-align: center; padding: 32px 0; color: #6b7280;">
                        Upload your CSV data to see demographic analysis
                    </div>
                </div>
            </div>

            <!-- Revenue Tab -->
            <div id="revenue" class="tab-content">
                <div class="card-header">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                    <h2>Revenue Analysis & Financial Impact</h2>
                </div>
                <div id="revenueResults">
                    <div style="text-align: center; padding: 32px 0; color: #6b7280;">
                        Upload your CSV data to see revenue analysis
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let rawData = [];
        let processedData = [];
        let conversionResults = {};
        let selectedTouchpoint = '6months';
        let currentTab = 'conversions';

        // Revenue estimates - Cannabis clinic specific pricing
        const revenueEstimates = {
            'New patient': 450,
            'Follow Up': 89,  // Updated: Each follow-up conversion = $89
            'Telehealth': 180,
            'default': 250,
            'conversion': 89  // All follow-up conversions worth $89
        };

        // Touchpoint definitions
        const touchpoints = {
            '3months': { name: '3 Month Follow-up', lookback: 90 },
            '5months': { name: '5 Month Follow-up', lookback: 150 },
            '6months': { name: '6 Month Follow-up', lookback: 180 },
            '9months': { name: '9 Month Follow-up', lookback: 270 },
            '12months': { name: '12 Month Follow-up', lookback: 365 }
        };

        // Parse DD/MM/YYYY date format
        function parseAustralianDate(dateString) {
            if (!dateString) return null;
            const cleanDate = dateString.split(' ')[0];
            const parts = cleanDate.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }

        // Calculate age from DOB
        function calculateAge(dobString) {
            const dob = parseAustralianDate(dobString);
            if (!dob) return null;
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const monthDiff = today.getMonth() - dob.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                age--;
            }
            return age;
        }

        // Estimate revenue per appointment type
        function estimateRevenue(appointmentType) {
            for (const type in revenueEstimates) {
                if (appointmentType && appointmentType.toLowerCase().includes(type.toLowerCase())) {
                    return revenueEstimates[type];
                }
            }
            return revenueEstimates.default;
        }

        // Extract location from appointment type
        function extractLocation(appointmentType) {
            if (!appointmentType) return 'Unknown';
            const locations = ['Tom', 'Bondi', 'NexGen', 'Chatswood'];
            for (const location of locations) {
                if (appointmentType.includes(location)) {
                    return location;
                }
            }
            if (appointmentType.toLowerCase().includes('telehealth')) {
                return 'Telehealth';
            }
            return 'Main Clinic';
        }

        // Determine booking channel
        function getBookingChannel(bookedBy) {
            if (!bookedBy || bookedBy.trim() === '') {
                return 'Online Booking';
            }
            return 'Staff Booking';
        }

        // Check if appointment was completed
        function isCompletedAppointment(status) {
            if (!status) return false;
            const completedStatuses = ['Completed', 'At billing', 'With doctor'];
            return completedStatuses.includes(status);
        }

        // Show status message
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message status-${type}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const data = lines.map(line => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim().replace(/"/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim().replace(/"/g, ''));
                return result;
            });
            
            return { data: data, errors: [] };
        }

        // Process CSV data
        function processCsvData(csvText) {
            console.log('Processing enhanced CSV data...');
            showStatus('üîÑ Processing comprehensive data analysis...', 'info');
            
            try {
                const parsed = parseCSV(csvText);
                console.log('Parse results:', parsed.data.length, 'rows');

                // Map all columns
                rawData = parsed.data.map((row, index) => {
                    return {
                        INTERNALID: row[0] || '',
                        DOB: row[1] || '',
                        SEX: row[2] || '',
                        BOOKEDBY: row[3] || '',
                        APPOINTMENTWITH: row[4] || '',
                        APPOINTMENTDATE: row[5] || '',
                        APPOINTMENTTYPE: row[6] || '',
                        APPOINTMENT_STATUS: row[7] || ''
                    };
                }).filter(row => {
                    return row.INTERNALID && row.APPOINTMENTDATE && 
                           row.INTERNALID !== '' && row.APPOINTMENTDATE !== '';
                });

                // Filter for completed appointments only
                processedData = rawData.filter(row => isCompletedAppointment(row.APPOINTMENT_STATUS));

                console.log('Raw data length:', rawData.length);
                console.log('Completed appointments:', processedData.length);

                if (processedData.length > 0) {
                    showStatus('‚úÖ Data processed successfully! Generating comprehensive analysis...', 'success');
                    updateDataStatus();
                    calculateAllAnalytics();
                } else {
                    showStatus('‚ùå No completed appointments found. Check your data format.', 'error');
                }
            } catch (error) {
                console.error('Error processing CSV:', error);
                showStatus('‚ùå Error processing data: ' + error.message, 'error');
            }
        }

        // Update data status display
        function updateDataStatus() {
            const uniquePatients = new Set(processedData.map(r => r.INTERNALID)).size;
            const noShowCount = rawData.filter(r => r.APPOINTMENT_STATUS === 'DNA').length;
            const noShowRate = Math.round((noShowCount / rawData.length) * 100);

            // Calculate estimated revenue
            const totalRevenue = processedData.reduce((sum, row) => {
                return sum + estimateRevenue(row.APPOINTMENTTYPE);
            }, 0);

            // Get date range
            const dates = processedData.map(r => parseAustralianDate(r.APPOINTMENTDATE))
                                     .filter(date => date !== null)
                                     .sort((a, b) => a - b);
            
            let dateRange = '-';
            if (dates.length > 0) {
                const startYear = dates[0].getFullYear();
                const endYear = dates[dates.length - 1].getFullYear();
                dateRange = startYear === endYear ? `${startYear}` : `${startYear} - ${endYear}`;
            }

            document.getElementById('totalRecords').textContent = rawData.length.toLocaleString();
            document.getElementById('completedAppointments').textContent = processedData.length.toLocaleString();
            document.getElementById('uniquePatients').textContent = uniquePatients.toLocaleString();
            document.getElementById('dateRange').textContent = dateRange;
            document.getElementById('noShowRate').textContent = noShowRate + '%';
            document.getElementById('estimatedRevenue').textContent = '$' + totalRevenue.toLocaleString();
            
            document.getElementById('dataStatus').classList.remove('hidden');
            document.getElementById('executiveSummary').classList.remove('hidden');
            
            // Enable export buttons
            document.getElementById('exportDataBtn').disabled = false;
            document.getElementById('executiveReportBtn').disabled = false;
        }

        // Calculate all analytics
        function calculateAllAnalytics() {
            console.log('=== CALCULATING COMPREHENSIVE ANALYTICS ===');
            
            showStatus('üîÑ Calculating conversion rates and business metrics...', 'info');
            
            // Calculate conversions
            calculateConversions();
            
            // Calculate other analytics
            calculatePractitionerPerformance();
            calculateChannelPerformance();
            calculateLocationPerformance();
            calculateDemographics();
            calculateRevenueAnalysis();
            
            // Update executive summary
            updateExecutiveSummary();
            
            console.log('=== ANALYTICS CALCULATION COMPLETE ===');
            showStatus('‚úÖ Complete business intelligence analysis ready!', 'success');
            
            updateDisplay();
        }

        // Calculate conversion rates (enhanced version)
        function calculateConversions() {
            console.log('Calculating conversion rates...');
            conversionResults = {};

            Object.keys(touchpoints).forEach(touchpointKey => {
                const touchpoint = touchpoints[touchpointKey];
                const monthlyResults = {};

                const allDates = [...new Set(processedData.map(row => row.APPOINTMENTDATE))];

                allDates.forEach((todayDate) => {
                    try {
                        const today = parseAustralianDate(todayDate);
                        if (!today || isNaN(today.getTime())) return;

                        const referenceDate = new Date(today);
                        referenceDate.setDate(referenceDate.getDate() - touchpoint.lookback);

                        // Find patients who had completed appointment on reference date
                        const eligiblePatients = processedData.filter(row => {
                            const appointmentDate = parseAustralianDate(row.APPOINTMENTDATE);
                            if (!appointmentDate) return false;
                            return appointmentDate.toDateString() === referenceDate.toDateString();
                        });

                        // Remove patients who already rebooked
                        const patientsNeedingReminder = eligiblePatients.filter(patient => {
                            const patientId = patient.INTERNALID;
                            const hasRebookedAlready = processedData.some(row => {
                                if (row.INTERNALID !== patientId) return false;
                                const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                                if (!apptDate) return false;
                                return apptDate > referenceDate && apptDate < today;
                            });
                            return !hasRebookedAlready;
                        });

                        // Check for conversions
                        const conversions = patientsNeedingReminder.filter(patient => {
                            const patientId = patient.INTERNALID;
                            const conversionWindowEnd = new Date(today);
                            conversionWindowEnd.setDate(conversionWindowEnd.getDate() + 30);

                            return processedData.some(row => {
                                if (row.INTERNALID !== patientId) return false;
                                const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                                if (!apptDate) return false;
                                return apptDate > today && apptDate <= conversionWindowEnd;
                            });
                        });

                        // Group by month
                        const monthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

                        if (!monthlyResults[monthKey]) {
                            monthlyResults[monthKey] = { 
                                remindersSent: 0, 
                                conversions: 0, 
                                month: monthKey,
                                revenue: 0 
                            };
                        }

                        monthlyResults[monthKey].remindersSent += patientsNeedingReminder.length;
                        monthlyResults[monthKey].conversions += conversions.length;
                        
                        // Calculate revenue from conversions - Each conversion = $89
                        const conversionRevenue = conversions.length * 89;
                        monthlyResults[monthKey].revenue += conversionRevenue;

                    } catch (error) {
                        console.error(`Error processing date "${todayDate}":`, error);
                    }
                });

                // Calculate conversion rates
                Object.keys(monthlyResults).forEach(month => {
                    const result = monthlyResults[month];
                    result.conversionRate = result.remindersSent > 0 
                        ? (result.conversions / result.remindersSent * 100).toFixed(1)
                        : '0.0';
                });

                conversionResults[touchpointKey] = Object.values(monthlyResults)
                    .sort((a, b) => a.month.localeCompare(b.month));
            });
        }

        // Calculate practitioner performance
        function calculatePractitionerPerformance() {
            const practitionerStats = {};
            
            processedData.forEach(row => {
                const practitioner = row.APPOINTMENTWITH || 'Unknown';
                if (!practitionerStats[practitioner]) {
                    practitionerStats[practitioner] = {
                        totalAppointments: 0,
                        uniquePatients: new Set(),
                        revenue: 0,
                        appointmentTypes: {}
                    };
                }
                
                practitionerStats[practitioner].totalAppointments++;
                practitionerStats[practitioner].uniquePatients.add(row.INTERNALID);
                practitionerStats[practitioner].revenue += estimateRevenue(row.APPOINTMENTTYPE);
                
                const apptType = row.APPOINTMENTTYPE || 'Unknown';
                practitionerStats[practitioner].appointmentTypes[apptType] = 
                    (practitionerStats[practitioner].appointmentTypes[apptType] || 0) + 1;
            });

            // Calculate no-show rates per practitioner
            const practitionerNoShows = {};
            rawData.forEach(row => {
                const practitioner = row.APPOINTMENTWITH || 'Unknown';
                if (!practitionerNoShows[practitioner]) {
                    practitionerNoShows[practitioner] = { total: 0, noShows: 0 };
                }
                practitionerNoShows[practitioner].total++;
                if (row.APPOINTMENT_STATUS === 'DNA') {
                    practitionerNoShows[practitioner].noShows++;
                }
            });

            // Convert to array and add no-show rates
            window.practitionerPerformance = Object.keys(practitionerStats).map(practitioner => {
                const stats = practitionerStats[practitioner];
                const noShowData = practitionerNoShows[practitioner] || { total: 0, noShows: 0 };
                const noShowRate = noShowData.total > 0 ? 
                    ((noShowData.noShows / noShowData.total) * 100).toFixed(1) : '0.0';
                
                return {
                    practitioner,
                    totalAppointments: stats.totalAppointments,
                    uniquePatients: stats.uniquePatients.size,
                    revenue: stats.revenue,
                    avgRevenuePerAppointment: Math.round(stats.revenue / stats.totalAppointments),
                    noShowRate: parseFloat(noShowRate),
                    topAppointmentType: Object.keys(stats.appointmentTypes)
                        .reduce((a, b) => stats.appointmentTypes[a] > stats.appointmentTypes[b] ? a : b)
                };
            }).sort((a, b) => b.revenue - a.revenue);
        }

        // Calculate channel performance
        function calculateChannelPerformance() {
            const channelStats = {};
            
            rawData.forEach(row => {
                const channel = getBookingChannel(row.BOOKEDBY);
                if (!channelStats[channel]) {
                    channelStats[channel] = {
                        totalBookings: 0,
                        completedAppointments: 0,
                        noShows: 0,
                        revenue: 0
                    };
                }
                
                channelStats[channel].totalBookings++;
                if (isCompletedAppointment(row.APPOINTMENT_STATUS)) {
                    channelStats[channel].completedAppointments++;
                    channelStats[channel].revenue += estimateRevenue(row.APPOINTMENTTYPE);
                }
                if (row.APPOINTMENT_STATUS === 'DNA') {
                    channelStats[channel].noShows++;
                }
            });

            window.channelPerformance = Object.keys(channelStats).map(channel => {
                const stats = channelStats[channel];
                const showRate = stats.totalBookings > 0 ? 
                    ((stats.completedAppointments / stats.totalBookings) * 100).toFixed(1) : '0.0';
                const noShowRate = stats.totalBookings > 0 ? 
                    ((stats.noShows / stats.totalBookings) * 100).toFixed(1) : '0.0';
                
                return {
                    channel,
                    totalBookings: stats.totalBookings,
                    completedAppointments: stats.completedAppointments,
                    showRate: parseFloat(showRate),
                    noShowRate: parseFloat(noShowRate),
                    revenue: stats.revenue,
                    avgRevenuePerBooking: Math.round(stats.revenue / stats.totalBookings)
                };
            }).sort((a, b) => b.revenue - a.revenue);
        }

        // Calculate location performance
        function calculateLocationPerformance() {
            const locationStats = {};
            
            processedData.forEach(row => {
                const location = extractLocation(row.APPOINTMENTTYPE);
                if (!locationStats[location]) {
                    locationStats[location] = {
                        totalAppointments: 0,
                        uniquePatients: new Set(),
                        revenue: 0,
                        appointmentTypes: {}
                    };
                }
                
                locationStats[location].totalAppointments++;
                locationStats[location].uniquePatients.add(row.INTERNALID);
                locationStats[location].revenue += estimateRevenue(row.APPOINTMENTTYPE);
                
                const apptType = row.APPOINTMENTTYPE || 'Unknown';
                locationStats[location].appointmentTypes[apptType] = 
                    (locationStats[location].appointmentTypes[apptType] || 0) + 1;
            });

            window.locationPerformance = Object.keys(locationStats).map(location => {
                const stats = locationStats[location];
                return {
                    location,
                    totalAppointments: stats.totalAppointments,
                    uniquePatients: stats.uniquePatients.size,
                    revenue: stats.revenue,
                    avgRevenuePerAppointment: Math.round(stats.revenue / stats.totalAppointments),
                    topAppointmentType: Object.keys(stats.appointmentTypes)
                        .reduce((a, b) => stats.appointmentTypes[a] > stats.appointmentTypes[b] ? a : b)
                };
            }).sort((a, b) => b.revenue - a.revenue);
        }

        // Calculate demographics
        function calculateDemographics() {
            const ageGroups = {
                '18-25': 0, '26-35': 0, '36-45': 0, '46-55': 0, '56-65': 0, '65+': 0
            };
            const genderStats = {};
            const ageRevenue = {};
            const genderRevenue = {};

            processedData.forEach(row => {
                // Age analysis
                const age = calculateAge(row.DOB);
                if (age !== null) {
                    let ageGroup;
                    if (age >= 18 && age <= 25) ageGroup = '18-25';
                    else if (age >= 26 && age <= 35) ageGroup = '26-35';
                    else if (age >= 36 && age <= 45) ageGroup = '36-45';
                    else if (age >= 46 && age <= 55) ageGroup = '46-55';
                    else if (age >= 56 && age <= 65) ageGroup = '56-65';
                    else if (age > 65) ageGroup = '65+';
                    
                    if (ageGroup) {
                        ageGroups[ageGroup]++;
                        ageRevenue[ageGroup] = (ageRevenue[ageGroup] || 0) + estimateRevenue(row.APPOINTMENTTYPE);
                    }
                }

                // Gender analysis
                const gender = row.SEX || 'Unknown';
                genderStats[gender] = (genderStats[gender] || 0) + 1;
                genderRevenue[gender] = (genderRevenue[gender] || 0) + estimateRevenue(row.APPOINTMENTTYPE);
            });

            window.demographicData = {
                ageGroups: Object.keys(ageGroups).map(group => ({
                    ageGroup: group,
                    count: ageGroups[group],
                    revenue: ageRevenue[group] || 0,
                    avgRevenue: ageGroups[group] > 0 ? Math.round((ageRevenue[group] || 0) / ageGroups[group]) : 0
                })),
                genderStats: Object.keys(genderStats).map(gender => ({
                    gender,
                    count: genderStats[gender],
                    revenue: genderRevenue[gender] || 0,
                    avgRevenue: genderStats[gender] > 0 ? Math.round((genderRevenue[gender] || 0) / genderStats[gender]) : 0
                }))
            };
        }

        // Calculate revenue analysis
        function calculateRevenueAnalysis() {
            const appointmentTypeRevenue = {};
            const monthlyRevenue = {};
            
            processedData.forEach(row => {
                const revenue = estimateRevenue(row.APPOINTMENTTYPE);
                const apptType = row.APPOINTMENTTYPE || 'Unknown';
                const date = parseAustralianDate(row.APPOINTMENTDATE);
                
                // Appointment type revenue
                if (!appointmentTypeRevenue[apptType]) {
                    appointmentTypeRevenue[apptType] = { count: 0, revenue: 0 };
                }
                appointmentTypeRevenue[apptType].count++;
                appointmentTypeRevenue[apptType].revenue += revenue;
                
                // Monthly revenue
                if (date) {
                    const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    monthlyRevenue[monthKey] = (monthlyRevenue[monthKey] || 0) + revenue;
                }
            });

            // Calculate lost revenue from no-shows
            const lostRevenue = rawData.filter(row => row.APPOINTMENT_STATUS === 'DNA')
                .reduce((sum, row) => sum + estimateRevenue(row.APPOINTMENTTYPE), 0);

            window.revenueAnalysis = {
                appointmentTypes: Object.keys(appointmentTypeRevenue).map(type => ({
                    appointmentType: type,
                    count: appointmentTypeRevenue[type].count,
                    revenue: appointmentTypeRevenue[type].revenue,
                    avgRevenue: Math.round(appointmentTypeRevenue[type].revenue / appointmentTypeRevenue[type].count)
                })).sort((a, b) => b.revenue - a.revenue),
                monthlyRevenue: Object.keys(monthlyRevenue).map(month => ({
                    month,
                    revenue: monthlyRevenue[month]
                })).sort((a, b) => a.month.localeCompare(b.month)),
                lostRevenue,
                totalRevenue: processedData.reduce((sum, row) => sum + estimateRevenue(row.APPOINTMENTTYPE), 0)
            };
        }

        // Update executive summary
        function updateExecutiveSummary() {
            const totalRevenue = processedData.reduce((sum, row) => sum + estimateRevenue(row.APPOINTMENTTYPE), 0);
            const lostRevenue = rawData.filter(row => row.APPOINTMENT_STATUS === 'DNA')
                .reduce((sum, row) => sum + estimateRevenue(row.APPOINTMENTTYPE), 0);
            
            // Calculate overall conversion rate from all touchpoints
            const totalConversions = Object.values(conversionResults).reduce((sum, touchpoint) => {
                return sum + touchpoint.reduce((tSum, month) => tSum + month.conversions, 0);
            }, 0);
            const totalReminders = Object.values(conversionResults).reduce((sum, touchpoint) => {
                return sum + touchpoint.reduce((tSum, month) => tSum + month.remindersSent, 0);
            }, 0);
            const overallConversionRate = totalReminders > 0 ? 
                ((totalConversions / totalReminders) * 100).toFixed(1) : '0.0';

            // Find best booking channel
            const bestChannel = window.channelPerformance && window.channelPerformance.length > 0 ? 
                window.channelPerformance[0].channel : 'N/A';

            document.getElementById('execTotalRevenue').textContent = '$' + totalRevenue.toLocaleString();
            document.getElementById('execNoShowLoss').textContent = '$' + lostRevenue.toLocaleString();
            document.getElementById('execConversionRate').textContent = overallConversionRate + '%';
            document.getElementById('execTopChannel').textContent = bestChannel;
        }

        // Update display based on current tab
        function updateDisplay() {
            switch(currentTab) {
                case 'conversions':
                    updateConversionsDisplay();
                    break;
                case 'practitioners':
                    updatePractitionersDisplay();
                    break;
                case 'channels':
                    updateChannelsDisplay();
                    break;
                case 'locations':
                    updateLocationsDisplay();
                    break;
                case 'demographics':
                    updateDemographicsDisplay();
                    break;
                case 'revenue':
                    updateRevenueDisplay();
                    break;
            }
            updateButtonStates();
        }

        // Update conversions display
        function updateConversionsDisplay() {
            const currentResults = conversionResults[selectedTouchpoint] || [];
            
            const totalReminders = currentResults.reduce((sum, r) => sum + r.remindersSent, 0);
            const totalConversions = currentResults.reduce((sum, r) => sum + r.conversions, 0);
            const totalRevenue = currentResults.reduce((sum, r) => sum + (r.revenue || 0), 0);
            // Note: Revenue represents follow-up conversions at $89 each
            const overallRate = totalReminders > 0 ? (totalConversions / totalReminders * 100).toFixed(1) : '0.0';

            document.getElementById('totalReminders').textContent = totalReminders.toLocaleString();
            document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
            document.getElementById('overallRate').textContent = overallRate + '%';
            document.getElementById('conversionRevenue').textContent = '$' + totalRevenue.toLocaleString();

            updateConversionsTable(currentResults);
        }

        // Update conversions table
        function updateConversionsTable(results) {
            const container = document.getElementById('conversionResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6b7280;">No conversion data available</div>';
                return;
            }

            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="text-right">Available Conversions</th>
                                <th class="text-right">Conversions</th>
                                <th class="text-right">Rate</th>
                                <th class="text-right">Revenue Recovery</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach((result, index) => {
                const rate = parseFloat(result.conversionRate);
                const rateClass = rate >= 20 ? 'rate-high' : rate >= 10 ? 'rate-medium' : 'rate-low';
                
                tableHTML += `
                    <tr class="zebra">
                        <td>${result.month}</td>
                        <td class="text-right">${result.remindersSent.toLocaleString()}</td>
                        <td class="text-right">${result.conversions.toLocaleString()}</td>
                        <td class="text-right">
                            <span class="conversion-rate ${rateClass}">${result.conversionRate}%</span>
                        </td>
                        <td class="text-right revenue-positive">$${(result.revenue || 0).toLocaleString()}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        // Update practitioners display
        function updatePractitionersDisplay() {
            const container = document.getElementById('practitionerResults');
            const data = window.practitionerPerformance || [];
            
            if (data.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6b7280;">No practitioner data available</div>';
                return;
            }

            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Practitioner</th>
                                <th class="text-right">Total Appointments</th>
                                <th class="text-right">Unique Patients</th>
                                <th class="text-right">Total Revenue</th>
                                <th class="text-right">Avg Revenue/Appointment</th>
                                <th class="text-right">No-Show Rate</th>
                                <th>Top Appointment Type</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach((practitioner, index) => {
                const noShowClass = practitioner.noShowRate < 10 ? 'rate-high' : 
                                  practitioner.noShowRate < 20 ? 'rate-medium' : 'rate-low';
                
                tableHTML += `
                    <tr class="zebra">
                        <td><strong>${practitioner.practitioner}</strong></td>
                        <td class="text-right">${practitioner.totalAppointments.toLocaleString()}</td>
                        <td class="text-right">${practitioner.uniquePatients.toLocaleString()}</td>
                        <td class="text-right revenue-positive">$${practitioner.revenue.toLocaleString()}</td>
                        <td class="text-right">$${practitioner.avgRevenuePerAppointment}</td>
                        <td class="text-right">
                            <span class="conversion-rate ${noShowClass}">${practitioner.noShowRate}%</span>
                        </td>
                        <td>${practitioner.topAppointmentType}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        // Update channels display
        function updateChannelsDisplay() {
            const container = document.getElementById('channelResults');
            const data = window.channelPerformance || [];
            
            if (data.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6b7280;">No channel data available</div>';
                return;
            }

            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Booking Channel</th>
                                <th class="text-right">Total Bookings</th>
                                <th class="text-right">Completed</th>
                                <th class="text-right">Show Rate</th>
                                <th class="text-right">No-Show Rate</th>
                                <th class="text-right">Total Revenue</th>
                                <th class="text-right">Avg Revenue/Booking</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach((channel, index) => {
                const showRateClass = channel.showRate >= 80 ? 'rate-high' : 
                                     channel.showRate >= 70 ? 'rate-medium' : 'rate-low';
                const noShowClass = channel.noShowRate < 10 ? 'rate-high' : 
                                   channel.noShowRate < 20 ? 'rate-medium' : 'rate-low';
                
                tableHTML += `
                    <tr class="zebra">
                        <td><strong>${channel.channel}</strong></td>
                        <td class="text-right">${channel.totalBookings.toLocaleString()}</td>
                        <td class="text-right">${channel.completedAppointments.toLocaleString()}</td>
                        <td class="text-right">
                            <span class="conversion-rate ${showRateClass}">${channel.showRate}%</span>
                        </td>
                        <td class="text-right">
                            <span class="conversion-rate ${noShowClass}">${channel.noShowRate}%</span>
                        </td>
                        <td class="text-right revenue-positive">$${channel.revenue.toLocaleString()}</td>
                        <td class="text-right">$${channel.avgRevenuePerBooking}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        // Update locations display
        function updateLocationsDisplay() {
            const container = document.getElementById('locationResults');
            const data = window.locationPerformance || [];
            
            if (data.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6b7280;">No location data available</div>';
                return;
            }

            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th class="text-right">Total Appointments</th>
                                <th class="text-right">Unique Patients</th>
                                <th class="text-right">Total Revenue</th>
                                <th class="text-right">Avg Revenue/Appointment</th>
                                <th>Top Appointment Type</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.forEach((location, index) => {
                tableHTML += `
                    <tr class="zebra">
                        <td><strong>${location.location}</strong></td>
                        <td class="text-right">${location.totalAppointments.toLocaleString()}</td>
                        <td class="text-right">${location.uniquePatients.toLocaleString()}</td>
                        <td class="text-right revenue-positive">$${location.revenue.toLocaleString()}</td>
                        <td class="text-right">$${location.avgRevenuePerAppointment}</td>
                        <td>${location.topAppointmentType}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        // Update demographics display
        function updateDemographicsDisplay() {
            const container = document.getElementById('demographicResults');
            const data = window.demographicData;
            
            if (!data) {
                container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6b7280;">No demographic data available</div>';
                return;
            }

            let html = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                    <div>
                        <h3 style="margin-bottom: 16px; font-weight: 600;">Age Group Analysis</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Age Group</th>
                                        <th class="text-right">Patients</th>
                                        <th class="text-right">Revenue</th>
                                        <th class="text-right">Avg Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            data.ageGroups.forEach((group, index) => {
                html += `
                    <tr class="zebra">
                        <td><strong>${group.ageGroup}</strong></td>
                        <td class="text-right">${group.count.toLocaleString()}</td>
                        <td class="text-right revenue-positive">$${group.revenue.toLocaleString()}</td>
                        <td class="text-right">$${group.avgRevenue}</td>
                    </tr>
                `;
            });

            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 16px; font-weight: 600;">Gender Analysis</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Gender</th>
                                        <th class="text-right">Patients</th>
                                        <th class="text-right">Revenue</th>
                                        <th class="text-right">Avg Revenue</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            data.genderStats.forEach((gender, index) => {
                html += `
                    <tr class="zebra">
                        <td><strong>${gender.gender}</strong></td>
                        <td class="text-right">${gender.count.toLocaleString()}</td>
                        <td class="text-right revenue-positive">$${gender.revenue.toLocaleString()}</td>
                        <td class="text-right">$${gender.avgRevenue}</td>
                    </tr>
                `;
            });

            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Update revenue display
        function updateRevenueDisplay() {
            const container = document.getElementById('revenueResults');
            const data = window.revenueAnalysis;
            
            if (!data) {
                container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6b7280;">No revenue data available</div>';
                return;
            }

            let html = `
                <div style="margin-bottom: 32px;">
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div>
                                <div class="summary-label">Total Revenue</div>
                                <div class="summary-value revenue-positive">$${data.totalRevenue.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div>
                                <div class="summary-label">Lost to No-Shows</div>
                                <div class="summary-value revenue-negative">$${data.lostRevenue.toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div>
                                <div class="summary-label">Recovery Potential</div>
                                <div class="summary-value" style="color: #7c3aed;">$${(data.totalRevenue + data.lostRevenue).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <h3 style="margin-bottom: 16px; font-weight: 600;">Revenue by Appointment Type</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Appointment Type</th>
                                <th class="text-right">Count</th>
                                <th class="text-right">Total Revenue</th>
                                <th class="text-right">Avg Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.appointmentTypes.forEach((type, index) => {
                html += `
                    <tr class="zebra">
                        <td><strong>${type.appointmentType}</strong></td>
                        <td class="text-right">${type.count.toLocaleString()}</td>
                        <td class="text-right revenue-positive">$${type.revenue.toLocaleString()}</td>
                        <td class="text-right">$${type.avgRevenue}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Update button states
        function updateButtonStates() {
            document.querySelectorAll('[data-touchpoint]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.touchpoint === selectedTouchpoint);
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === currentTab);
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === currentTab);
            });
        }

        // Export comprehensive results
        function exportComprehensiveResults() {
            if (Object.keys(conversionResults).length === 0) {
                alert('No data to export. Please upload and process your CSV first.');
                return;
            }
            
            let csvContent = '';
            
            // Executive Summary
            csvContent += 'EXECUTIVE SUMMARY\n';
            csvContent += 'Metric,Value\n';
            csvContent += `Total Records,${rawData.length}\n`;
            csvContent += `Completed Appointments,${processedData.length}\n`;
            csvContent += `No-Show Rate,${Math.round((rawData.filter(r => r.APPOINTMENT_STATUS === 'DNA').length / rawData.length) * 100)}%\n`;
            csvContent += `Estimated Total Revenue,$${processedData.reduce((sum, row) => sum + estimateRevenue(row.APPOINTMENTTYPE), 0).toLocaleString()}\n\n`;
            
            // Conversion Results
            csvContent += 'CONVERSION ANALYSIS\n';
            csvContent += 'Touchpoint,Month,Available Conversions,Conversions,Conversion Rate,Revenue Recovery\n';
            Object.keys(touchpoints).forEach(touchpointKey => {
                const touchpointName = touchpoints[touchpointKey].name;
                const results = conversionResults[touchpointKey] || [];
                results.forEach(result => {
                    csvContent += `"${touchpointName}","${result.month}",${result.remindersSent},${result.conversions},"${result.conversionRate}%","$${(result.revenue || 0).toLocaleString()}"\n`;
                });
            });
            csvContent += '\n';
            
            // Practitioner Performance
            if (window.practitionerPerformance) {
                csvContent += 'PRACTITIONER PERFORMANCE\n';
                csvContent += 'Practitioner,Total Appointments,Unique Patients,Total Revenue,Avg Revenue per Appointment,No-Show Rate,Top Appointment Type\n';
                window.practitionerPerformance.forEach(p => {
                    csvContent += `"${p.practitioner}",${p.totalAppointments},${p.uniquePatients},"$${p.revenue.toLocaleString()}","$${p.avgRevenuePerAppointment}","${p.noShowRate}%","${p.topAppointmentType}"\n`;
                });
                csvContent += '\n';
            }
            
            // Channel Performance
            if (window.channelPerformance) {
                csvContent += 'BOOKING CHANNEL PERFORMANCE\n';
                csvContent += 'Channel,Total Bookings,Completed Appointments,Show Rate,No-Show Rate,Total Revenue,Avg Revenue per Booking\n';
                window.channelPerformance.forEach(c => {
                    csvContent += `"${c.channel}",${c.totalBookings},${c.completedAppointments},"${c.showRate}%","${c.noShowRate}%","$${c.revenue.toLocaleString()}","$${c.avgRevenuePerBooking}"\n`;
                });
                csvContent += '\n';
            }
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'cannabis_clinic_business_intelligence_report.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('‚úÖ Complete business intelligence report exported successfully!', 'success');
            } else {
                alert('Your browser does not support file downloads');
            }
        }

        // Export executive summary
        function exportExecutiveSummary() {
            if (Object.keys(conversionResults).length === 0) {
                alert('No data to export. Please upload and process your CSV first.');
                return;
            }
            
            const totalRevenue = processedData.reduce((sum, row) => sum + estimateRevenue(row.APPOINTMENTTYPE), 0);
            const lostRevenue = rawData.filter(row => row.APPOINTMENT_STATUS === 'DNA')
                .reduce((sum, row) => sum + estimateRevenue(row.APPOINTMENTTYPE), 0);
            const noShowRate = Math.round((rawData.filter(r => r.APPOINTMENT_STATUS === 'DNA').length / rawData.length) * 100);
            
            let csvContent = 'CANNABIS CLINIC - EXECUTIVE SUMMARY REPORT\n';
            csvContent += `Generated: ${new Date().toLocaleDateString()}\n\n`;
            
            csvContent += 'KEY BUSINESS METRICS\n';
            csvContent += 'Metric,Value,Impact\n';
            csvContent += `Total Revenue Generated,"$${totalRevenue.toLocaleString()}","Primary business driver"\n`;
            csvContent += `Revenue Lost to No-Shows,"$${lostRevenue.toLocaleString()}","Immediate recovery opportunity"\n`;
            csvContent += `No-Show Rate,"${noShowRate}%","Operational efficiency target"\n`;
            csvContent += `Total Unique Patients,"${new Set(processedData.map(r => r.INTERNALID)).size.toLocaleString()}","Patient base size"\n`;
            csvContent += `Completed Appointments,"${processedData.length.toLocaleString()}","Service delivery volume"\n\n`;
            
            csvContent += 'TOP PERFORMANCE INSIGHTS\n';
            csvContent += 'Category,Top Performer,Performance Metric\n';
            
            if (window.practitionerPerformance && window.practitionerPerformance.length > 0) {
                const topPractitioner = window.practitionerPerformance[0];
                csvContent += `Best Practitioner,"${topPractitioner.practitioner}","$${topPractitioner.revenue.toLocaleString()} revenue"\n`;
            }
            
            if (window.channelPerformance && window.channelPerformance.length > 0) {
                const topChannel = window.channelPerformance[0];
                csvContent += `Best Booking Channel,"${topChannel.channel}","${topChannel.showRate}% show rate"\n`;
            }
            
            if (window.locationPerformance && window.locationPerformance.length > 0) {
                const topLocation = window.locationPerformance[0];
                csvContent += `Best Location,"${topLocation.location}","$${topLocation.revenue.toLocaleString()} revenue"\n`;
            }
            
            csvContent += '\n';
            csvContent += 'ACTIONABLE RECOMMENDATIONS\n';
            csvContent += 'Priority,Recommendation,Expected Impact\n';
            csvContent += '1,"Implement automated follow-up system","Each conversion = $89 revenue recovery"\n';
            csvContent += '2,"Address no-show patterns","Recover 
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'executive_summary_cannabis_clinic.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('‚úÖ Executive summary exported successfully!', 'success');
            } else {
                alert('Your browser does not support file downloads');
            }
        }

        // Event listeners
        document.getElementById('csvFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.csv')) {
                showStatus('‚ùå Please select a CSV file', 'error');
                return;
            }
            
            showStatus('üîÑ Reading file and preparing comprehensive analysis...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                processCsvData(e.target.result);
            };
            reader.onerror = function() {
                showStatus('‚ùå Error reading file', 'error');
            };
            reader.readAsText(file);
        });

        // Export buttons
        document.getElementById('exportDataBtn').addEventListener('click', exportComprehensiveResults);
        document.getElementById('executiveReportBtn').addEventListener('click', exportExecutiveSummary);

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                currentTab = this.dataset.tab;
                updateDisplay();
            });
        });

        // Touchpoint selection
        document.getElementById('touchpointButtons').addEventListener('click', function(e) {
            if (e.target.dataset.touchpoint) {
                selectedTouchpoint = e.target.dataset.touchpoint;
                updateDisplay();
            }
        });

        // Initialize
        updateButtonStates();
        
        console.log('Enhanced Cannabis Clinic Business Intelligence Dashboard initialized');
    </script>
</body>
</html> + lostRevenue.toLocaleString() + ' in lost revenue"\n';
            csvContent += '3,"Optimize booking channels","Focus resources on highest-performing channels"\n';
            csvContent += '4,"Scale successful follow-up touchpoints","Multiply $89 conversion value across patient base"\n';
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'executive_summary_cannabis_clinic.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('‚úÖ Executive summary exported successfully!', 'success');
            } else {
                alert('Your browser does not support file downloads');
            }
        }

        // Event listeners
        document.getElementById('csvFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.csv')) {
                showStatus('‚ùå Please select a CSV file', 'error');
                return;
            }
            
            showStatus('üîÑ Reading file and preparing comprehensive analysis...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                processCsvData(e.target.result);
            };
            reader.onerror = function() {
                showStatus('‚ùå Error reading file', 'error');
            };
            reader.readAsText(file);
        });

        // Export buttons
        document.getElementById('exportDataBtn').addEventListener('click', exportComprehensiveResults);
        document.getElementById('executiveReportBtn').addEventListener('click', exportExecutiveSummary);

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                currentTab = this.dataset.tab;
                updateDisplay();
            });
        });

        // Touchpoint selection
        document.getElementById('touchpointButtons').addEventListener('click', function(e) {
            if (e.target.dataset.touchpoint) {
                selectedTouchpoint = e.target.dataset.touchpoint;
                updateDisplay();
            }
        });

        // Initialize
        updateButtonStates();
        
        console.log('Enhanced Cannabis Clinic Business Intelligence Dashboard initialized');
    </script>
</body>
</html>

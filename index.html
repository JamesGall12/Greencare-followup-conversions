<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Follow-Up Conversion Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.6;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .header p {
            color: #6b7280;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .icon {
            width: 20px;
            height: 20px;
            color: #2563eb;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .file-upload input {
            margin-bottom: 8px;
        }

        .status-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .button {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 14px;
        }

        .button:hover {
            border-color: #3b82f6;
        }

        .button.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .button.purple {
            background: #7c3aed;
            color: white;
            border-color: #7c3aed;
        }

        .button.purple:not(.active) {
            background: white;
            color: #374151;
        }

        .button.purple:not(.active):hover {
            border-color: #7c3aed;
        }

        .auto-button {
            background: #2563eb;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 12px 0;
        }

        .auto-button:hover {
            background: #1d4ed8;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            padding: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            margin-top: 4px;
        }

        .summary-label {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            font-weight: 600;
        }

        .text-right {
            text-align: right;
        }

        .conversion-rate {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }

        .rate-high { background: #dcfce7; color: #166534; }
        .rate-medium { background: #fef3c7; color: #92400e; }
        .rate-low { background: #fee2e2; color: #991b1b; }

        .zebra:nth-child(even) {
            background: #f9fafb;
        }

        .insights {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 16px;
            margin-top: 24px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            font-size: 14px;
        }

        .status-info { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .status-success { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .status-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }

        @media (max-width: 768px) {
            .button-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enhanced Follow-Up Conversion Dashboard</h1>
            <p>Track conversion rates & advanced analytics for SMS follow-up touchpoints across your patient journey</p>
        </div>

        <!-- Data Upload Section -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <h2>Data Upload</h2>
            </div>
            
            <div class="file-upload">
                <input type="file" id="csvFile" accept=".csv" />
                <button id="exportDataBtn" class="auto-button" style="background: #7c3aed; margin-top: 12px;" disabled>
                    📤 Export Results
                </button>
                <div id="statusMessage" class="hidden"></div>
                <p style="font-size: 14px; color: #6b7280; margin-top: 8px;">
                    Upload your enhanced clinic CSV file with 8 columns:<br>
                    <strong>Column A</strong> = INTERNALID (Patient IDs)<br>
                    <strong>Column B</strong> = APPOINTMENTDATE (DD/MM/YYYY)<br>
                    <strong>Column C</strong> = DOB (Date of Birth)<br>
                    <strong>Column D</strong> = SEX (Gender)<br>
                    <strong>Column E</strong> = BOOKEDBY (Employee or blank=online)<br>
                    <strong>Column F</strong> = APPOINTMENTWITH (Practitioner)<br>
                    <strong>Column G</strong> = APPOINTMENTTYPE (Type)<br>
                    <strong>Column H</strong> = APPOINTMENT_STATUS (Outcome)
                </p>
            </div>
            
            <div id="dataStatus" class="hidden">
                <div class="status-success">
                    <div style="display: flex; align-items: center; gap: 8px; color: #166534; margin-bottom: 8px;">
                        <span style="font-size: 18px;">✅</span>
                        <span style="font-weight: 600;">Data Loaded Successfully</span>
                    </div>
                    <div class="status-grid">
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Total Appointments:</span><br>
                            <span id="totalAppointments" style="font-weight: bold; color: #15803d;">0</span>
                        </div>
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Unique Patients:</span><br>
                            <span id="uniquePatients" style="font-weight: bold; color: #15803d;">0</span>
                        </div>
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Date Range:</span><br>
                            <span id="dateRange" style="font-weight: bold; color: #15803d;">-</span>
                        </div>
                        <div>
                            <span style="color: #16a34a; font-size: 14px;">Return Rate:</span><br>
                            <span id="returnRate" style="font-weight: bold; color: #15803d;">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Touchpoint Selection -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <h2>Follow-Up Touchpoint</h2>
            </div>
            <div class="button-grid" id="touchpointButtons">
                <button class="button" data-touchpoint="3months">
                    <div style="font-weight: 500;">3 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">90 days</div>
                </button>
                <button class="button" data-touchpoint="5months">
                    <div style="font-weight: 500;">5 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">150 days</div>
                </button>
                <button class="button active" data-touchpoint="6months">
                    <div style="font-weight: 500;">6 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">180 days</div>
                </button>
                <button class="button" data-touchpoint="9months">
                    <div style="font-weight: 500;">9 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">270 days</div>
                </button>
                <button class="button" data-touchpoint="12months">
                    <div style="font-weight: 500;">12 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">365 days</div>
                </button>
                <button class="button" data-touchpoint="18months">
                    <div style="font-weight: 500;">18 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">540 days</div>
                </button>
                <button class="button" data-touchpoint="24months">
                    <div style="font-weight: 500;">24 Month Follow-up</div>
                    <div style="font-size: 12px; opacity: 0.7;">720 days</div>
                </button>
            </div>
            
            <!-- Conversion Trend Chart -->
            <div style="margin-top: 24px; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                <h3 style="font-weight: 600; color: #1f2937; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    📈 <span id="chartTitle">Conversion Rate Trend - 6 Month Follow-up</span>
                </h3>
                <div id="conversionChart" style="width: 100%; height: 300px; background: white; border-radius: 6px; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; color: #6b7280;">
                    Upload data to see conversion trend chart
                </div>
            </div>
        </div>

        <!-- Month Filter -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #7c3aed;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <h2>Month Filter</h2>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 12px;" id="monthButtons">
                <button class="button purple active" data-month="all">All Months</button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="summary-grid">
            <div class="summary-card">
                <div>
                    <div class="summary-label">Available Conversions</div>
                    <div class="summary-value" id="totalReminders">0</div>
                </div>
                <svg style="width: 32px; height: 32px; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-.5a6 6 0 01-3 5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                </svg>
            </div>
            <div class="summary-card">
                <div>
                    <div class="summary-label">Conversions</div>
                    <div class="summary-value" id="totalConversions">0</div>
                </div>
                <svg style="width: 32px; height: 32px; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
            </div>
            <div class="summary-card">
                <div>
                    <div class="summary-label">Conversion Rate</div>
                    <div class="summary-value" id="overallRate">0%</div>
                </div>
                <svg style="width: 32px; height: 32px; color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <h2>Conversion Results</h2>
                <span style="font-size: 14px; color: #6b7280;" id="currentTouchpointLabel">(6 Month Follow-up)</span>
            </div>
            
            <div id="resultsTable">
                <div style="text-align: center; padding: 32px 0; color: #6b7280;">
                    Upload your CSV data to see conversion results
                </div>
            </div>
        </div>

        <!-- Demographics Analysis -->
        <div class="card" id="demographicsCard" style="display: none;">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #16a34a;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <h2>Demographics & Patient Insights</h2>
            </div>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <div>
                        <div class="summary-label">Age Groups</div>
                        <div id="ageBreakdown" style="font-size: 14px; margin-top: 8px;">-</div>
                    </div>
                    <svg style="width: 32px; height: 32px; color: #16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <div class="summary-card">
                    <div>
                        <div class="summary-label">Gender Split</div>
                        <div id="genderBreakdown" style="font-size: 14px; margin-top: 8px;">-</div>
                    </div>
                    <svg style="width: 32px; height: 32px; color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-.5a6 6 0 01-3 5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </div>
                <div class="summary-card">
                    <div>
                        <div class="summary-label">Top Converting Age</div>
                        <div class="summary-value" id="topConvertingAge" style="font-size: 1.5rem;">-</div>
                    </div>
                    <svg style="width: 32px; height: 32px; color: #dc2626;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                </div>
            </div>
            
            <div id="demographicsTable"></div>
        </div>

        <!-- Practitioner Performance -->
        <div class="card" id="practitionerCard" style="display: none;">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #2563eb;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                </svg>
                <h2>Practitioner Performance</h2>
            </div>
            
            <div id="practitionerTable"></div>
        </div>

        <!-- Booking Channel Analysis -->
        <div class="card" id="bookingChannelCard" style="display: none;">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #7c3aed;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                <h2>Booking Channel Effectiveness</h2>
            </div>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <div>
                        <div class="summary-label">Online Bookings</div>
                        <div class="summary-value" id="onlineConversionRate">-</div>
                    </div>
                    <svg style="width: 32px; height: 32px; color: #059669;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div class="summary-card">
                    <div>
                        <div class="summary-label">Staff Bookings</div>
                        <div class="summary-value" id="staffConversionRate">-</div>
                    </div>
                    <svg style="width: 32px; height: 32px; color: #dc2626;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                </div>
                <div class="summary-card">
                    <div>
                        <div class="summary-label">Channel ROI</div>
                        <div class="summary-value" id="channelROI" style="font-size: 1.2rem;">-</div>
                    </div>
                    <svg style="width: 32px; height: 32px; color: #7c3aed;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                </div>
            </div>
            
            <div id="bookingChannelTable"></div>
        </div>

        <!-- Appointment Analysis -->
        <div class="card" id="appointmentAnalysisCard" style="display: none;">
            <div class="card-header">
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #059669;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                </svg>
                <h2>Appointment Type & Outcome Analysis</h2>
            </div>
            
            <div id="appointmentAnalysisTable"></div>
        </div>

        <!-- Insights -->
        <div class="insights">
            <h3 style="font-weight: 600; color: #1e40af; margin-bottom: 8px;">Enhanced Analytics & Insights</h3>
            <div class="insights-grid">
                <div>
                    <h4 style="font-weight: 500; margin-bottom: 4px; color: #1e40af;">Advanced Analytics Available:</h4>
                    <ul style="font-size: 14px; color: #1e40af;">
                        <li>• <strong>Demographics:</strong> Age groups, gender patterns, top converting segments</li>
                        <li>• <strong>Practitioner Performance:</strong> Individual conversion rates and patient retention</li>
                        <li>• <strong>Booking Channels:</strong> Online vs staff booking effectiveness and ROI</li>
                        <li>• <strong>Appointment Analysis:</strong> Type and outcome impact on conversions</li>
                    </ul>
                </div>
                <div>
                    <h4 style="font-weight: 500; margin-bottom: 4px; color: #1e40af;">Business Intelligence:</h4>
                    <ul style="font-size: 14px; color: #1e40af;">
                        <li>• Identify high-value patient segments for targeted campaigns</li>
                        <li>• Optimize practitioner allocation and training needs</li>
                        <li>• Measure automation ROI vs human touchpoints</li>
                        <li>• Predict churn risk and optimize intervention timing</li>
                    </ul>
                </div>
            </div>
            
            <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px;">
                <h4 style="font-weight: 500; margin-bottom: 4px; color: #0369a1;">Data Format (8 Columns):</h4>
                <div style="font-size: 13px; color: #0369a1; font-family: monospace;">
                    A=INTERNALID | B=APPOINTMENTDATE | C=DOB | D=SEX | E=BOOKEDBY | F=APPOINTMENTWITH | G=APPOINTMENTTYPE | H=APPOINTMENT_STATUS
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let parsedData = [];
        let conversionResults = {};
        let selectedTouchpoint = '6months';
        let selectedMonth = 'all';

        // Touchpoint definitions - Updated for medical cannabis clinic
        const touchpoints = {
            '3months': { name: '3 Month Follow-up', lookback: 90 },
            '5months': { name: '5 Month Follow-up', lookback: 150 },
            '6months': { name: '6 Month Follow-up', lookback: 180 },
            '9months': { name: '9 Month Follow-up', lookback: 270 },
            '12months': { name: '12 Month Follow-up', lookback: 365 },
            '18months': { name: '18 Month Follow-up', lookback: 540 },
            '24months': { name: '24 Month Follow-up', lookback: 720 }
        };

        // Parse DD/MM/YYYY date format correctly
        function parseAustralianDate(dateString) {
            if (!dateString) return null;
            
            // Handle "01/05/2025 00:00:00" format
            const cleanDate = dateString.split(' ')[0]; // Remove time part
            const parts = cleanDate.split('/');
            
            if (parts.length !== 3) return null;
            
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // JavaScript months are 0-based
            const year = parseInt(parts[2], 10);
            
            return new Date(year, month, day);
        }

        // Simple CSV parser
        function parseCSV(csvText) {
            console.log('Parsing CSV data...');
            const lines = csvText.split('\n').filter(line => line.trim());
            const data = lines.map(line => {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim().replace(/"/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim().replace(/"/g, ''));
                return result;
            });
            
            return { data: data, errors: [] };
        }

        // Show status message with progress support
        function showStatus(message, type = 'info', showProgress = false) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message status-${type}`;
            
            if (showProgress) {
                statusEl.innerHTML = `
                    <div>${message}</div>
                    <div style="background: #e5e7eb; border-radius: 4px; height: 8px; margin-top: 8px; overflow: hidden;">
                        <div id="progressBar" style="background: #2563eb; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                `;
            } else {
                statusEl.textContent = message;
            }
            
            statusEl.classList.remove('hidden');
            
            if (type === 'success' && !showProgress) {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        // Helper function to calculate age from DOB
        function calculateAge(dobString) {
            if (!dobString) return null;
            
            const birthDate = parseAustralianDate(dobString);
            if (!birthDate) return null;
            
            const today = new Date();
            const age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                return age - 1;
            }
            return age;
        }

        // Helper function to get age group
        function getAgeGroup(age) {
            if (age === null || age === undefined) return 'Unknown';
            if (age < 25) return '18-24';
            if (age < 35) return '25-34';
            if (age < 45) return '35-44';
            if (age < 55) return '45-54';
            if (age < 65) return '55-64';
            return '65+';
        }

        // Calculate demographics analysis
        function calculateDemographics() {
            if (!selectedTouchpoint || !conversionResults[selectedTouchpoint]) {
                return;
            }

            console.log('Calculating demographics for', selectedTouchpoint);
            
            // Get current touchpoint data
            const touchpoint = touchpoints[selectedTouchpoint];
            const demographicData = {};
            
            // Analyze each date in the touchpoint
            const allDates = [...new Set(parsedData.map(row => row.APPOINTMENTDATE))];
            
            allDates.forEach(todayDate => {
                const today = parseAustralianDate(todayDate);
                if (!today) return;
                
                const referenceDate = new Date(today);
                referenceDate.setDate(referenceDate.getDate() - touchpoint.lookback);
                
                // Find eligible patients
                const eligiblePatients = parsedData.filter(row => {
                    const appointmentDate = parseAustralianDate(row.APPOINTMENTDATE);
                    if (!appointmentDate) return false;
                    return appointmentDate.toDateString() === referenceDate.toDateString();
                });
                
                // Remove already rebooked patients
                const patientsNeedingReminder = eligiblePatients.filter(patient => {
                    const patientId = patient.INTERNALID;
                    const hasRebookedAlready = parsedData.some(row => {
                        if (row.INTERNALID !== patientId) return false;
                        const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                        if (!apptDate) return false;
                        return apptDate > referenceDate && apptDate < today;
                    });
                    return !hasRebookedAlready;
                });
                
                // Check for conversions
                patientsNeedingReminder.forEach(patient => {
                    const patientId = patient.INTERNALID;
                    const age = calculateAge(patient.DOB);
                    const ageGroup = getAgeGroup(age);
                    const gender = patient.SEX || 'Unknown';
                    
                    // Initialize demographic tracking
                    if (!demographicData[ageGroup]) {
                        demographicData[ageGroup] = { total: 0, conversions: 0, genderBreakdown: {} };
                    }
                    if (!demographicData[ageGroup].genderBreakdown[gender]) {
                        demographicData[ageGroup].genderBreakdown[gender] = { total: 0, conversions: 0 };
                    }
                    
                    demographicData[ageGroup].total++;
                    demographicData[ageGroup].genderBreakdown[gender].total++;
                    
                    // Check if this patient converted
                    const conversionWindowEnd = new Date(today);
                    conversionWindowEnd.setDate(conversionWindowEnd.getDate() + 30);
                    
                    const converted = parsedData.some(row => {
                        if (row.INTERNALID !== patientId) return false;
                        const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                        if (!apptDate) return false;
                        return apptDate > today && apptDate <= conversionWindowEnd;
                    });
                    
                    if (converted) {
                        demographicData[ageGroup].conversions++;
                        demographicData[ageGroup].genderBreakdown[gender].conversions++;
                    }
                });
            });
            
            // Update display
            updateDemographicsDisplay(demographicData);
        }

        // Update demographics display
        function updateDemographicsDisplay(demographicData) {
            const card = document.getElementById('demographicsCard');
            if (Object.keys(demographicData).length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            
            // Calculate overall statistics
            let totalPatients = 0;
            let totalMale = 0, totalFemale = 0;
            let bestAge = { group: '', rate: 0 };
            
            Object.keys(demographicData).forEach(ageGroup => {
                const data = demographicData[ageGroup];
                totalPatients += data.total;
                
                // Gender totals
                if (data.genderBreakdown.Male) totalMale += data.genderBreakdown.Male.total;
                if (data.genderBreakdown.Female) totalFemale += data.genderBreakdown.Female.total;
                
                // Best converting age group
                const rate = data.total > 0 ? (data.conversions / data.total) * 100 : 0;
                if (rate > bestAge.rate) {
                    bestAge = { group: ageGroup, rate: rate };
                }
            });
            
            // Update summary cards
            const ageGroups = Object.keys(demographicData).sort();
            document.getElementById('ageBreakdown').innerHTML = ageGroups.map(group => 
                `<div>${group}: ${demographicData[group].total} (${((demographicData[group].total / totalPatients) * 100).toFixed(1)}%)</div>`
            ).join('');
            
            const malePercent = totalPatients > 0 ? ((totalMale / totalPatients) * 100).toFixed(1) : 0;
            const femalePercent = totalPatients > 0 ? ((totalFemale / totalPatients) * 100).toFixed(1) : 0;
            document.getElementById('genderBreakdown').innerHTML = `
                <div>Male: ${totalMale} (${malePercent}%)</div>
                <div>Female: ${totalFemale} (${femalePercent}%)</div>
            `;
            
            document.getElementById('topConvertingAge').textContent = bestAge.group ? 
                `${bestAge.group} (${bestAge.rate.toFixed(1)}%)` : '-';
            
            // Create detailed table
            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Age Group</th>
                                <th class="text-right">Available Conversions</th>
                                <th class="text-right">Conversions</th>
                                <th class="text-right">Conversion Rate</th>
                                <th class="text-right">Male Rate</th>
                                <th class="text-right">Female Rate</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            ageGroups.forEach((ageGroup, index) => {
                const data = demographicData[ageGroup];
                const overallRate = data.total > 0 ? ((data.conversions / data.total) * 100).toFixed(1) : '0.0';
                const maleData = data.genderBreakdown.Male || { total: 0, conversions: 0 };
                const femaleData = data.genderBreakdown.Female || { total: 0, conversions: 0 };
                const maleRate = maleData.total > 0 ? ((maleData.conversions / maleData.total) * 100).toFixed(1) : '0.0';
                const femaleRate = femaleData.total > 0 ? ((femaleData.conversions / femaleData.total) * 100).toFixed(1) : '0.0';
                
                const rateClass = parseFloat(overallRate) >= 20 ? 'rate-high' : parseFloat(overallRate) >= 10 ? 'rate-medium' : 'rate-low';
                
                tableHTML += `
                    <tr class="zebra">
                        <td><strong>${ageGroup}</strong></td>
                        <td class="text-right">${data.total}</td>
                        <td class="text-right">${data.conversions}</td>
                        <td class="text-right">
                            <span class="conversion-rate ${rateClass}">${overallRate}%</span>
                        </td>
                        <td class="text-right">${maleRate}%</td>
                        <td class="text-right">${femaleRate}%</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table></div>';
            document.getElementById('demographicsTable').innerHTML = tableHTML;
        }

        // Calculate practitioner performance
        function calculatePractitionerPerformance() {
            if (!selectedTouchpoint || !conversionResults[selectedTouchpoint]) {
                return;
            }

            console.log('Calculating practitioner performance for', selectedTouchpoint);
            
            const touchpoint = touchpoints[selectedTouchpoint];
            const practitionerData = {};
            
            // Analyze practitioner performance
            const allDates = [...new Set(parsedData.map(row => row.APPOINTMENTDATE))];
            
            allDates.forEach(todayDate => {
                const today = parseAustralianDate(todayDate);
                if (!today) return;
                
                const referenceDate = new Date(today);
                referenceDate.setDate(referenceDate.getDate() - touchpoint.lookback);
                
                // Find eligible patients
                const eligiblePatients = parsedData.filter(row => {
                    const appointmentDate = parseAustralianDate(row.APPOINTMENTDATE);
                    if (!appointmentDate) return false;
                    return appointmentDate.toDateString() === referenceDate.toDateString();
                });
                
                // Remove already rebooked patients
                const patientsNeedingReminder = eligiblePatients.filter(patient => {
                    const patientId = patient.INTERNALID;
                    const hasRebookedAlready = parsedData.some(row => {
                        if (row.INTERNALID !== patientId) return false;
                        const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                        if (!apptDate) return false;
                        return apptDate > referenceDate && apptDate < today;
                    });
                    return !hasRebookedAlready;
                });
                
                // Track by practitioner
                patientsNeedingReminder.forEach(patient => {
                    const practitioner = patient.APPOINTMENTWITH || 'Unknown';
                    const patientId = patient.INTERNALID;
                    
                    if (!practitionerData[practitioner]) {
                        practitionerData[practitioner] = { total: 0, conversions: 0 };
                    }
                    
                    practitionerData[practitioner].total++;
                    
                    // Check if this patient converted
                    const conversionWindowEnd = new Date(today);
                    conversionWindowEnd.setDate(conversionWindowEnd.getDate() + 30);
                    
                    const converted = parsedData.some(row => {
                        if (row.INTERNALID !== patientId) return false;
                        const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                        if (!apptDate) return false;
                        return apptDate > today && apptDate <= conversionWindowEnd;
                    });
                    
                    if (converted) {
                        practitionerData[practitioner].conversions++;
                    }
                });
            });
            
            updatePractitionerDisplay(practitionerData);
        }

        // Update practitioner display
        function updatePractitionerDisplay(practitionerData) {
            const card = document.getElementById('practitionerCard');
            if (Object.keys(practitionerData).length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            
            // Sort practitioners by conversion rate
            const sortedPractitioners = Object.keys(practitionerData)
                .map(name => ({
                    name,
                    ...practitionerData[name],
                    rate: practitionerData[name].total > 0 ? 
                        (practitionerData[name].conversions / practitionerData[name].total * 100).toFixed(1) : '0.0'
                }))
                .sort((a, b) => parseFloat(b.rate) - parseFloat(a.rate));
            
            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Practitioner</th>
                                <th class="text-right">Available Conversions</th>
                                <th class="text-right">Conversions</th>
                                <th class="text-right">Conversion Rate</th>
                                <th class="text-right">Performance</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedPractitioners.forEach((practitioner, index) => {
                const rate = parseFloat(practitioner.rate);
                const rateClass = rate >= 20 ? 'rate-high' : rate >= 10 ? 'rate-medium' : 'rate-low';
                const performanceIcon = rate >= 20 ? '🏆' : rate >= 10 ? '✅' : '⚠️';
                
                tableHTML += `
                    <tr class="zebra">
                        <td><strong>${practitioner.name}</strong></td>
                        <td class="text-right">${practitioner.total}</td>
                        <td class="text-right">${practitioner.conversions}</td>
                        <td class="text-right">
                            <span class="conversion-rate ${rateClass}">${practitioner.rate}%</span>
                        </td>
                        <td class="text-right">${performanceIcon}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table></div>';
            document.getElementById('practitionerTable').innerHTML = tableHTML;
        }

        // Calculate booking channel analysis
        function calculateBookingChannelAnalysis() {
            if (!selectedTouchpoint || !conversionResults[selectedTouchpoint]) {
                return;
            }

            console.log('Calculating booking channel analysis for', selectedTouchpoint);
            
            const touchpoint = touchpoints[selectedTouchpoint];
            const channelData = { online: { total: 0, conversions: 0 }, staff: { total: 0, conversions: 0 } };
            
            const allDates = [...new Set(parsedData.map(row => row.APPOINTMENTDATE))];
            
            allDates.forEach(todayDate => {
                const today = parseAustralianDate(todayDate);
                if (!today) return;
                
                const referenceDate = new Date(today);
                referenceDate.setDate(referenceDate.getDate() - touchpoint.lookback);
                
                // Find eligible patients
                const eligiblePatients = parsedData.filter(row => {
                    const appointmentDate = parseAustralianDate(row.APPOINTMENTDATE);
                    if (!appointmentDate) return false;
                    return appointmentDate.toDateString() === referenceDate.toDateString();
                });
                
                // Remove already rebooked patients
                const patientsNeedingReminder = eligiblePatients.filter(patient => {
                    const patientId = patient.INTERNALID;
                    const hasRebookedAlready = parsedData.some(row => {
                        if (row.INTERNALID !== patientId) return false;
                        const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                        if (!apptDate) return false;
                        return apptDate > referenceDate && apptDate < today;
                    });
                    return !hasRebookedAlready;
                });
                
                // Track by booking channel
                patientsNeedingReminder.forEach(patient => {
                    const patientId = patient.INTERNALID;
                    const bookedBy = patient.BOOKEDBY || '';
                    const isOnline = bookedBy === '' || bookedBy.toLowerCase().includes('online');
                    const channel = isOnline ? 'online' : 'staff';
                    
                    channelData[channel].total++;
                    
                    // Check if this patient converted
                    const conversionWindowEnd = new Date(today);
                    conversionWindowEnd.setDate(conversionWindowEnd.getDate() + 30);
                    
                    const converted = parsedData.some(row => {
                        if (row.INTERNALID !== patientId) return false;
                        const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                        if (!apptDate) return false;
                        return apptDate > today && apptDate <= conversionWindowEnd;
                    });
                    
                    if (converted) {
                        channelData[channel].conversions++;
                    }
                });
            });
            
            updateBookingChannelDisplay(channelData);
        }

        // Update booking channel display
        function updateBookingChannelDisplay(channelData) {
            const card = document.getElementById('bookingChannelCard');
            const totalPatients = channelData.online.total + channelData.staff.total;
            
            if (totalPatients === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            
            // Calculate rates
            const onlineRate = channelData.online.total > 0 ? 
                (channelData.online.conversions / channelData.online.total * 100).toFixed(1) : '0.0';
            const staffRate = channelData.staff.total > 0 ? 
                (channelData.staff.conversions / channelData.staff.total * 100).toFixed(1) : '0.0';
            
            // Update summary cards
            document.getElementById('onlineConversionRate').textContent = `${onlineRate}%`;
            document.getElementById('staffConversionRate').textContent = `${staffRate}%`;
            
            // Simple ROI calculation (online is "free", staff bookings cost money)
            const onlineROI = parseFloat(onlineRate);
            const staffROI = parseFloat(staffRate) - 5; // Assume staff booking costs ~5% points
            const roiText = onlineROI > staffROI ? 'Online Wins' : 'Staff Wins';
            document.getElementById('channelROI').textContent = roiText;
            
            // Create detailed table
            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Booking Channel</th>
                                <th class="text-right">Available Conversions</th>
                                <th class="text-right">Conversions</th>
                                <th class="text-right">Conversion Rate</th>
                                <th class="text-right">Share of Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const channels = [
                { name: 'Online Bookings', data: channelData.online, rate: onlineRate },
                { name: 'Staff Bookings', data: channelData.staff, rate: staffRate }
            ];
            
            channels.forEach((channel, index) => {
                const rate = parseFloat(channel.rate);
                const rateClass = rate >= 20 ? 'rate-high' : rate >= 10 ? 'rate-medium' : 'rate-low';
                const share = totalPatients > 0 ? ((channel.data.total / totalPatients) * 100).toFixed(1) : '0.0';
                
                tableHTML += `
                    <tr class="zebra">
                        <td><strong>${channel.name}</strong></td>
                        <td class="text-right">${channel.data.total}</td>
                        <td class="text-right">${channel.data.conversions}</td>
                        <td class="text-right">
                            <span class="conversion-rate ${rateClass}">${channel.rate}%</span>
                        </td>
                        <td class="text-right">${share}%</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table></div>';
            document.getElementById('bookingChannelTable').innerHTML = tableHTML;
        }

        // Calculate appointment analysis
        function calculateAppointmentAnalysis() {
            if (!selectedTouchpoint || !conversionResults[selectedTouchpoint]) {
                return;
            }

            console.log('Calculating appointment analysis for', selectedTouchpoint);
            
            const touchpoint = touchpoints[selectedTouchpoint];
            const appointmentData = {};
            
            const allDates = [...new Set(parsedData.map(row => row.APPOINTMENTDATE))];
            
            allDates.forEach(todayDate => {
                const today = parseAustralianDate(todayDate);
                if (!today) return;
                
                const referenceDate = new Date(today);
                referenceDate.setDate(referenceDate.getDate() - touchpoint.lookback);
                
                // Find eligible patients
                const eligiblePatients = parsedData.filter(row => {
                    const appointmentDate = parseAustralianDate(row.APPOINTMENTDATE);
                    if (!appointmentDate) return false;
                    return appointmentDate.toDateString() === referenceDate.toDateString();
                });
                
                // Remove already rebooked patients
                const patientsNeedingReminder = eligiblePatients.filter(patient => {
                    const patientId = patient.INTERNALID;
                    const hasRebookedAlready = parsedData.some(row => {
                        if (row.INTERNALID !== patientId) return false;
                        const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                        if (!apptDate) return false;
                        return apptDate > referenceDate && apptDate < today;
                    });
                    return !hasRebookedAlready;
                });
                
                // Track by appointment type and status
                patientsNeedingReminder.forEach(patient => {
                    const patientId = patient.INTERNALID;
                    const appointmentType = patient.APPOINTMENTTYPE || 'Unknown';
                    const appointmentStatus = patient.APPOINTMENT_STATUS || 'Unknown';
                    
                    const key = `${appointmentType} - ${appointmentStatus}`;
                    
                    if (!appointmentData[key]) {
                        appointmentData[key] = { total: 0, conversions: 0, type: appointmentType, status: appointmentStatus };
                    }
                    
                    appointmentData[key].total++;
                    
                    // Check if this patient converted
                    const conversionWindowEnd = new Date(today);
                    conversionWindowEnd.setDate(conversionWindowEnd.getDate() + 30);
                    
                    const converted = parsedData.some(row => {
                        if (row.INTERNALID !== patientId) return false;
                        const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                        if (!apptDate) return false;
                        return apptDate > today && apptDate <= conversionWindowEnd;
                    });
                    
                    if (converted) {
                        appointmentData[key].conversions++;
                    }
                });
            });
            
            updateAppointmentAnalysisDisplay(appointmentData);
        }

        // Update appointment analysis display
        function updateAppointmentAnalysisDisplay(appointmentData) {
            const card = document.getElementById('appointmentAnalysisCard');
            if (Object.keys(appointmentData).length === 0) {
                card.style.display = 'none';
                return;
            }
            
            card.style.display = 'block';
            
            // Sort by conversion rate
            const sortedAppointments = Object.keys(appointmentData)
                .map(key => ({
                    key,
                    ...appointmentData[key],
                    rate: appointmentData[key].total > 0 ? 
                        (appointmentData[key].conversions / appointmentData[key].total * 100).toFixed(1) : '0.0'
                }))
                .sort((a, b) => parseFloat(b.rate) - parseFloat(a.rate));
            
            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Appointment Type</th>
                                <th>Status</th>
                                <th class="text-right">Available Conversions</th>
                                <th class="text-right">Conversions</th>
                                <th class="text-right">Conversion Rate</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedAppointments.forEach((appointment, index) => {
                const rate = parseFloat(appointment.rate);
                const rateClass = rate >= 20 ? 'rate-high' : rate >= 10 ? 'rate-medium' : 'rate-low';
                
                tableHTML += `
                    <tr class="zebra">
                        <td><strong>${appointment.type}</strong></td>
                        <td>${appointment.status}</td>
                        <td class="text-right">${appointment.total}</td>
                        <td class="text-right">${appointment.conversions}</td>
                        <td class="text-right">
                            <span class="conversion-rate ${rateClass}">${appointment.rate}%</span>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table></div>';
            document.getElementById('appointmentAnalysisTable').innerHTML = tableHTML;
        }

        // Export conversion results for verification
        function exportConversionResults() {
            if (Object.keys(conversionResults).length === 0) {
                alert('No conversion results to export. Please wait for calculations to complete.');
                return;
            }
            
            console.log('📤 Exporting conversion results...');
            
            // Create CSV content
            let csvContent = 'Touchpoint,Month,Available Conversions,Conversions,Conversion Rate\n';
            
            Object.keys(touchpoints).forEach(touchpointKey => {
                const touchpointName = touchpoints[touchpointKey].name;
                const results = conversionResults[touchpointKey] || [];
                
                results.forEach(result => {
                    csvContent += `"${touchpointName}","${result.month}",${result.remindersSent},${result.conversions},"${result.conversionRate}%"\n`;
                });
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'conversion_analysis_results.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus('✅ Results exported to conversion_analysis_results.csv', 'success');
                console.log('📤 Export complete');
            } else {
                alert('Your browser does not support file downloads');
            }
        }

        // Process CSV data
        function processCsvData(csvText) {
            console.log('Processing CSV data...');
            showStatus('🔄 Processing data...', 'info');
            
            try {
                const parsed = parseCSV(csvText);
                console.log('Parse results:', parsed.data.length, 'rows');

                // Map to your actual column positions: A=0, B=1, C=2, etc.
                parsedData = parsed.data.map((row, index) => {
                    // Only log first 3 rows to avoid console spam
                    if (index < 3) {
                        console.log(`Row ${index}:`, row);
                    }
                    return {
                        INTERNALID: row[0] || '',           // Column A
                        APPOINTMENTDATE: row[1] || '',      // Column B
                        DOB: row[2] || '',                  // Column C
                        SEX: row[3] || '',                  // Column D
                        BOOKEDBY: row[4] || '',             // Column E
                        APPOINTMENTWITH: row[5] || '',      // Column F
                        APPOINTMENTTYPE: row[6] || '',      // Column G
                        APPOINTMENT_STATUS: row[7] || ''    // Column H
                    };
                }).filter(row => {
                    return row.INTERNALID && row.APPOINTMENTDATE && 
                           row.INTERNALID !== '' && row.APPOINTMENTDATE !== '';
                });

                console.log('Filtered data length:', parsedData.length);

                if (parsedData.length > 0) {
                    showStatus('✅ Data processed successfully!', 'success');
                    updateDataStatus();
                    calculateAllConversions();
                } else {
                    showStatus('❌ No valid data found. Check your CSV format.', 'error');
                }
            } catch (error) {
                console.error('Error processing CSV:', error);
                showStatus('❌ Error processing data: ' + error.message, 'error');
            }
        }

        // Update data status display
        function updateDataStatus() {
            const uniquePatients = new Set(parsedData.map(r => r.INTERNALID)).size;
            const patientCounts = {};
            parsedData.forEach(row => {
                patientCounts[row.INTERNALID] = (patientCounts[row.INTERNALID] || 0) + 1;
            });
            const returnPatients = Object.values(patientCounts).filter(count => count > 1).length;
            const returnRate = Math.round((returnPatients / uniquePatients) * 100);

            // Get date range using Australian date parsing
            const dates = parsedData.map(r => parseAustralianDate(r.APPOINTMENTDATE))
                                   .filter(date => date !== null)
                                   .sort((a, b) => a - b);
            
            let dateRange = '-';
            if (dates.length > 0) {
                const startYear = dates[0].getFullYear();
                const endYear = dates[dates.length - 1].getFullYear();
                dateRange = startYear === endYear ? `${startYear}` : `${startYear} - ${endYear}`;
            }

            document.getElementById('totalAppointments').textContent = parsedData.length.toLocaleString();
            document.getElementById('uniquePatients').textContent = uniquePatients.toLocaleString();
            document.getElementById('dateRange').textContent = dateRange;
            document.getElementById('returnRate').textContent = returnRate + '%';
            document.getElementById('dataStatus').classList.remove('hidden');
        }

        // Calculate conversions for all touchpoints
        function calculateAllConversions() {
            console.log('=== STARTING CONVERSION CALCULATION ===');
            console.log('Total parsed data:', parsedData.length);
            
            showStatus('🔄 Calculating conversions...', 'info');
            
            // Check date formats first
            console.log('Sample appointment dates (DD/MM/YYYY format):');
            parsedData.slice(0, 3).forEach((row, i) => {
                const originalDate = row.APPOINTMENTDATE;
                const parsedDate = parseAustralianDate(originalDate);
                console.log(`${i}: "${originalDate}" -> parsed: ${parsedDate ? parsedDate.toDateString() : 'Invalid'}`);
            });
            
            conversionResults = {};

            Object.keys(touchpoints).forEach(touchpointKey => {
                console.log(`\n--- Processing ${touchpointKey} (${touchpoints[touchpointKey].lookback} days back) ---`);
                
                const touchpoint = touchpoints[touchpointKey];
                const monthlyResults = {};

                const allDates = [...new Set(parsedData.map(row => row.APPOINTMENTDATE))];
                console.log(`Unique appointment dates: ${allDates.length}`);

                let processedDates = 0;
                let totalEligibleFound = 0;
                let totalRemindersNeeded = 0;
                let totalConversions = 0;

                allDates.forEach((todayDate, index) => {
                    try {
                        const today = parseAustralianDate(todayDate);
                        if (!today || isNaN(today.getTime())) {
                            return;
                        }

                        const referenceDate = new Date(today);
                        referenceDate.setDate(referenceDate.getDate() - touchpoint.lookback);

                        // Debug first few iterations
                        if (index < 2) {
                            console.log(`\nIteration ${index}:`);
                            console.log(`Today: ${today.toDateString()}`);
                            console.log(`Reference date (${touchpoint.lookback} days back): ${referenceDate.toDateString()}`);
                        }

                        // Find patients who had appointment exactly on reference date
                        const eligiblePatients = parsedData.filter(row => {
                            const appointmentDate = parseAustralianDate(row.APPOINTMENTDATE);
                            if (!appointmentDate) return false;
                            return appointmentDate.toDateString() === referenceDate.toDateString();
                        });

                        if (index < 2) {
                            console.log(`Patients with appointments on ${referenceDate.toDateString()}: ${eligiblePatients.length}`);
                        }

                        totalEligibleFound += eligiblePatients.length;

                        // Remove patients who already rebooked between reference date and today
                        const patientsNeedingReminder = eligiblePatients.filter(patient => {
                            const patientId = patient.INTERNALID;
                            const hasRebookedAlready = parsedData.some(row => {
                                if (row.INTERNALID !== patientId) return false;
                                const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                                if (!apptDate) return false;
                                return apptDate > referenceDate && apptDate < today;
                            });
                            return !hasRebookedAlready;
                        });

                        if (index < 2) {
                            console.log(`Available conversions: ${patientsNeedingReminder.length}`);
                        }

                        totalRemindersNeeded += patientsNeedingReminder.length;

                        // Check for conversions (appointments within 30 days after today)
                        const conversions = patientsNeedingReminder.filter(patient => {
                            const patientId = patient.INTERNALID;
                            const conversionWindowEnd = new Date(today);
                            conversionWindowEnd.setDate(conversionWindowEnd.getDate() + 30);

                            return parsedData.some(row => {
                                if (row.INTERNALID !== patientId) return false;
                                const apptDate = parseAustralianDate(row.APPOINTMENTDATE);
                                if (!apptDate) return false;
                                return apptDate > today && apptDate <= conversionWindowEnd;
                            });
                        });

                        if (index < 2) {
                            console.log(`Conversions found: ${conversions.length}`);
                            const conversionWindowEnd = new Date(today);
                            conversionWindowEnd.setDate(conversionWindowEnd.getDate() + 30);
                            console.log(`Conversion window: ${today.toDateString()} to ${conversionWindowEnd.toDateString()}`);
                        }

                        totalConversions += conversions.length;

                        // Group by month
                        const monthKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

                        if (!monthlyResults[monthKey]) {
                            monthlyResults[monthKey] = { remindersSent: 0, conversions: 0, month: monthKey };
                        }

                        monthlyResults[monthKey].remindersSent += patientsNeedingReminder.length;
                        monthlyResults[monthKey].conversions += conversions.length;

                        processedDates++;

                    } catch (error) {
                        console.error(`Error processing date "${todayDate}":`, error);
                    }
                });

                console.log(`\n${touchpointKey} Summary:`);
                console.log(`- Processed dates: ${processedDates}`);
                console.log(`- Total eligible patients found: ${totalEligibleFound}`);
                console.log(`- Total available conversions: ${totalRemindersNeeded}`);
                console.log(`- Total conversions: ${totalConversions}`);

                // Calculate conversion rates
                Object.keys(monthlyResults).forEach(month => {
                    const result = monthlyResults[month];
                    result.conversionRate = result.remindersSent > 0 
                        ? (result.conversions / result.remindersSent * 100).toFixed(1)
                        : '0.0';
                });

                conversionResults[touchpointKey] = Object.values(monthlyResults).sort((a, b) => a.month.localeCompare(b.month));
                
                console.log(`Monthly results for ${touchpointKey}:`, Object.keys(monthlyResults).length, 'months');
            });

            console.log('=== CONVERSION CALCULATION COMPLETE ===');
            showStatus('✅ Conversion analysis complete!', 'success');
            updateMonthButtons();
            updateDisplay();
            updateConversionChart();
            
            // Enable export button
            document.getElementById('exportDataBtn').disabled = false;
        }

        // Update month filter buttons
        function updateMonthButtons() {
            const months = new Set();
            Object.values(conversionResults).forEach(touchpointData => {
                touchpointData.forEach(result => months.add(result.month));
            });

            const monthButtons = document.getElementById('monthButtons');
            monthButtons.innerHTML = '<button class="button purple active" data-month="all">All Months</button>';

            Array.from(months).sort().forEach(month => {
                const button = document.createElement('button');
                button.className = 'button purple';
                button.dataset.month = month;
                button.textContent = month;
                monthButtons.appendChild(button);
            });

            // Add event listener directly to the month buttons container
            monthButtons.removeEventListener('click', handleMonthButtonClick);
            monthButtons.addEventListener('click', handleMonthButtonClick);
        }

        // Month button click handler
        function handleMonthButtonClick(e) {
            if (e.target.dataset.month) {
                selectedMonth = e.target.dataset.month;
                console.log('Month selected:', selectedMonth);
                updateDisplay();
            }
        }

        // Create conversion trend chart
        function updateConversionChart() {
            const currentResults = conversionResults[selectedTouchpoint] || [];
            const chartContainer = document.getElementById('conversionChart');
            const chartTitle = document.getElementById('chartTitle');
            
            // Update chart title
            chartTitle.textContent = `Conversion Rate Trend - ${touchpoints[selectedTouchpoint].name}`;
            
            if (currentResults.length === 0) {
                chartContainer.innerHTML = '<div style="color: #6b7280;">No data available for chart</div>';
                return;
            }
            
            // Chart dimensions and margins
            const width = chartContainer.offsetWidth || 800;
            const height = 300;
            const margin = { top: 20, right: 30, bottom: 60, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Prepare data
            const data = currentResults.map(result => ({
                month: result.month,
                rate: parseFloat(result.conversionRate)
            }));
            
            // Get min/max values
            const maxRate = Math.max(...data.map(d => d.rate));
            const minRate = Math.min(...data.map(d => d.rate));
            const yMax = Math.max(maxRate * 1.1, 5); // At least 5% for scale
            
            // Create SVG
            let svg = `
                <svg width="${width}" height="${height}" style="background: white;">
                    <!-- Grid lines -->
                    <defs>
                        <pattern id="grid" width="40" height="30" patternUnits="userSpaceOnUse">
                            <path d="M 40 0 L 0 0 0 30" fill="none" stroke="#f1f5f9" stroke-width="1"/>
                        </pattern>
                    </defs>
                    <rect x="${margin.left}" y="${margin.top}" width="${chartWidth}" height="${chartHeight}" fill="url(#grid)" />
                    
                    <!-- Y-axis -->
                    <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + chartHeight}" stroke="#d1d5db" stroke-width="2"/>
                    
                    <!-- X-axis -->
                    <line x1="${margin.left}" y1="${margin.top + chartHeight}" x2="${margin.left + chartWidth}" y2="${margin.top + chartHeight}" stroke="#d1d5db" stroke-width="2"/>
                    
                    <!-- Y-axis labels -->
            `;
            
            // Add Y-axis labels (0% to yMax%)
            for (let i = 0; i <= 5; i++) {
                const yValue = (yMax / 5) * i;
                const y = margin.top + chartHeight - (i / 5) * chartHeight;
                svg += `
                    <text x="${margin.left - 10}" y="${y + 5}" text-anchor="end" font-size="12" fill="#6b7280">
                        ${yValue.toFixed(1)}%
                    </text>
                    <line x1="${margin.left - 5}" y1="${y}" x2="${margin.left}" y2="${y}" stroke="#d1d5db" stroke-width="1"/>
                `;
            }
            
            // Add X-axis labels and data points
            const points = [];
            data.forEach((d, index) => {
                const x = data.length === 1 ? margin.left + chartWidth / 2 : margin.left + (index / (data.length - 1)) * chartWidth;
                const y = margin.top + chartHeight - (d.rate / yMax) * chartHeight;
                
                points.push(`${x},${y}`);
                
                // X-axis labels
                svg += `
                    <text x="${x}" y="${margin.top + chartHeight + 20}" text-anchor="middle" font-size="11" fill="#6b7280">
                        ${d.month}
                    </text>
                `;
                
                // Data points
                svg += `
                    <circle cx="${x}" cy="${y}" r="4" fill="#2563eb" stroke="white" stroke-width="2"/>
                    <text x="${x}" y="${y - 10}" text-anchor="middle" font-size="10" fill="#1f2937" font-weight="600">
                        ${d.rate}%
                    </text>
                `;
            });
            
            // Add trend line
            if (points.length > 1) {
                svg += `<polyline points="${points.join(' ')}" fill="none" stroke="#2563eb" stroke-width="3" stroke-linecap="round"/>`;
            }
            
            // Add axis labels
            svg += `
                <!-- Y-axis label -->
                <text x="20" y="${margin.top + chartHeight / 2}" text-anchor="middle" font-size="14" fill="#374151" font-weight="600" transform="rotate(-90, 20, ${margin.top + chartHeight / 2})">
                    Conversion Rate (%)
                </text>
                
                <!-- X-axis label -->
                <text x="${margin.left + chartWidth / 2}" y="${height - 10}" text-anchor="middle" font-size="14" fill="#374151" font-weight="600">
                    Month
                </text>
            `;
            
            svg += '</svg>';
            
            chartContainer.innerHTML = svg;
        }

        // Update display
        function updateDisplay() {
            const currentResults = conversionResults[selectedTouchpoint] || [];
            const filteredResults = selectedMonth === 'all' 
                ? currentResults 
                : currentResults.filter(result => result.month === selectedMonth);

            const totalReminders = filteredResults.reduce((sum, r) => sum + r.remindersSent, 0);
            const totalConversions = filteredResults.reduce((sum, r) => sum + r.conversions, 0);
            const overallRate = totalReminders > 0 ? (totalConversions / totalReminders * 100).toFixed(1) : '0.0';

            document.getElementById('totalReminders').textContent = totalReminders.toLocaleString();
            document.getElementById('totalConversions').textContent = totalConversions.toLocaleString();
            document.getElementById('overallRate').textContent = overallRate + '%';

            updateResultsTable(filteredResults);
            updateButtonStates();
            updateConversionChart();
            
            // Update new analytics sections
            calculateDemographics();
            calculatePractitionerPerformance();
            calculateBookingChannelAnalysis();
            calculateAppointmentAnalysis();
        }

        // Update results table
        function updateResultsTable(results) {
            const container = document.getElementById('resultsTable');
            
            if (results.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 32px 0; color: #6b7280;">No data available for the selected touchpoint and month</div>';
                return;
            }

            let tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="text-right">Available Conversions</th>
                                <th class="text-right">Conversions</th>
                                <th class="text-right">Conversion Rate</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach((result, index) => {
                const rate = parseFloat(result.conversionRate);
                const rateClass = rate >= 20 ? 'rate-high' : rate >= 10 ? 'rate-medium' : 'rate-low';
                
                tableHTML += `
                    <tr class="zebra">
                        <td>${result.month}</td>
                        <td class="text-right">${result.remindersSent.toLocaleString()}</td>
                        <td class="text-right">${result.conversions.toLocaleString()}</td>
                        <td class="text-right">
                            <span class="conversion-rate ${rateClass}">${result.conversionRate}%</span>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        // Update button states
        function updateButtonStates() {
            document.querySelectorAll('[data-touchpoint]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.touchpoint === selectedTouchpoint);
            });
            document.querySelectorAll('[data-month]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.month === selectedMonth);
            });
            document.getElementById('currentTouchpointLabel').textContent = `(${touchpoints[selectedTouchpoint].name})`;
        }

        // Touchpoint button click handler
        function handleTouchpointButtonClick(e) {
            if (e.target.dataset.touchpoint) {
                selectedTouchpoint = e.target.dataset.touchpoint;
                console.log('Touchpoint selected:', selectedTouchpoint);
                updateDisplay();
            }
        }

        // File upload handler
        document.getElementById('csvFile').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.csv')) {
                showStatus('❌ Please select a CSV file', 'error');
                return;
            }
            
            showStatus('🔄 Reading file...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                processCsvData(e.target.result);
            };
            reader.onerror = function() {
                showStatus('❌ Error reading file', 'error');
            };
            reader.readAsText(file);
        });

        // Export button
        document.getElementById('exportDataBtn').addEventListener('click', function() {
            exportConversionResults();
        });

        // Touchpoint buttons - ensure clean event handling
        const touchpointContainer = document.getElementById('touchpointButtons');
        touchpointContainer.removeEventListener('click', handleTouchpointButtonClick);
        touchpointContainer.addEventListener('click', handleTouchpointButtonClick);

        // Initialize
        updateButtonStates();
        
        // Make chart responsive to window resize
        window.addEventListener('resize', function() {
            if (Object.keys(conversionResults).length > 0) {
                setTimeout(updateConversionChart, 100);
            }
        });
        
        console.log('Enhanced Dashboard initialized - All event listeners attached properly');
    </script>
</body>
</html>
